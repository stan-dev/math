language: cpp

before_script:
  - eval "${MATRIX_EVAL}"
  - echo ${CXX}
  - ${CXX} --version
  - echo "CC=$CXX" > make/local

############################################################################
# Install and set for 
# Thanks to JuliaGPU https://github.com/JuliaGPU/OpenCL.jl
# and boost https://github.com/boostorg/compute
############################################################################

before_install:
  - if [ $TRAVIS_OS_NAME = "linux" ]; then
    bash .travis/amd_sdk.sh;
    tar -xjf AMD-SDK.tar.bz2;
    AMDAPPSDK=${HOME}/AMDAPPSDK;
    export OPENCL_VENDOR_PATH=${AMDAPPSDK}/etc/OpenCL/vendors;
    mkdir -p ${OPENCL_VENDOR_PATH};
    sh AMD-APP-SDK*.sh --tar -xf -C ${AMDAPPSDK};
    echo libamdocl64.so > ${OPENCL_VENDOR_PATH}/amdocl64.icd;
    export LD_LIBRARY_PATH=${AMDAPPSDK}/lib/x86_64:${LD_LIBRARY_PATH};
    chmod +x ${AMDAPPSDK}/bin/x86_64/clinfo;
    ${AMDAPPSDK}/bin/x86_64/clinfo;
  fi;
   - ln -s /usr/lib/x86_64/libOpenCL.so.1 /usr/lib/libOpenCL.so

linux_clang: &linux_clang
  os: linux
  compiler: "clang-3.8"
  addons: 
    apt:
      sources: [ 'ubuntu-toolchain-r-test', 'llvm-toolchain-precise-3.8' ]
      packages: [ 'clang-3.8', 'libc++-dev' ]

linux_gcc: &linux_gcc
  os: linux
  compiler: "gcc-4.9"
  addons:
    apt:
      sources: [ 'ubuntu-toolchain-r-test' ]
      packages: [ 'g++-4.9' ]


matrix:
  fast_finish: true
  include:
    - <<: *linux_clang
      env:
        - MATRIX_EVAL="CXX=clang++-3.8"
          TESTFOLDER="test/unit/math/memory test/unit/math/prim/scal test/unit/math/prim/arr"
    - <<: *linux_clang
      env:
        - MATRIX_EVAL="CXX=clang++-3.8"
          TESTFOLDER="test/unit/math/prim/mat/err test/unit/math/prim/mat/meta test/unit/math/prim/mat/prob test/unit/math/prim/mat/vectorize"
    - <<: *linux_clang
      env:
        - MATRIX_EVAL="CXX=clang++-3.8"
          TESTFOLDER=test/unit/math/prim/mat/fun
    - <<: *linux_clang
      env:
        - MATRIX_EVAL="CXX=clang++-3.8"
          TESTFOLDER="test/unit/math/rev/scal test/unit/math/rev/arr"
    - <<: *linux_clang
      env:
        - MATRIX_EVAL="CXX=clang++-3.8"
          TESTFOLDER=test/unit/math/rev/mat/fun
    - <<: *linux_clang
      env:
        - MATRIX_EVAL="CXX=clang++-3.8"
          TESTFOLDER="test/unit/math/rev/mat/err test/unit/math/rev/mat/functor test/unit/math/rev/mat/meta test/unit/math/rev/mat/prob test/unit/math/rev/mat/vectorize"
    - <<: *linux_clang
      env:
        - MATRIX_EVAL="CXX=clang++-3.8"
          TESTFOLDER=test/unit/math/fwd/mat
    - <<: *linux_clang
      env:
        - MATRIX_EVAL="CXX=clang++-3.8"
          TESTFOLDER="test/unit/math/fwd/arr test/unit/math/fwd/core test/unit/math/fwd/scal"
    - <<: *linux_gcc
      env:
        - MATRIX_EVAL="CXX=g++-4.9"
          TESTFOLDER="test/unit/math/memory test/unit/math/prim/scal test/unit/math/prim/arr"
    - <<: *linux_gcc
      env:
        - MATRIX_EVAL="CXX=g++-4.9"
          TESTFOLDER="test/unit/math/prim/mat/err test/unit/math/prim/mat/meta test/unit/math/prim/mat/prob test/unit/math/prim/mat/vectorize"
    - <<: *linux_gcc
      env:
        - MATRIX_EVAL="CXX=g++-4.9"
          TESTFOLDER=test/unit/math/prim/mat/fun
    - <<: *linux_gcc
      env:
        - MATRIX_EVAL="CXX=g++-4.9"
          TESTFOLDER="test/unit/math/rev/scal test/unit/math/rev/arr"
    - <<: *linux_gcc
      env:
        - MATRIX_EVAL="CXX=g++-4.9"
          TESTFOLDER=test/unit/math/rev/mat/fun
    - <<: *linux_gcc
      env:
        - MATRIX_EVAL="CXX=g++-4.9"
          TESTFOLDER="test/unit/math/rev/mat/err test/unit/math/rev/mat/functor test/unit/math/rev/mat/meta test/unit/math/rev/mat/prob test/unit/math/rev/mat/vectorize"
    - <<: *linux_gcc
      env:
        - MATRIX_EVAL="CXX=g++-4.9"
          TESTFOLDER=test/unit/math/fwd/mat
    - <<: *linux_gcc
      env:
        - MATRIX_EVAL="CXX=g++-4.9"
          TESTFOLDER="test/unit/math/fwd/arr test/unit/math/fwd/core test/unit/math/fwd/scal"
    - <<: *linux_gcc
      env:
        - MATRIX_EVAL="CXX=g++-4.9"
          TESTFOLDER="test/unit/math/mix/arr test/unit/math/mix/core"
    - <<: *linux_gcc
      env:
        - MATRIX_EVAL="CXX=g++-4.9"
          TESTFOLDER="test/unit/math/mix/mat/fun/[A-l]*"
    - <<: *linux_gcc
      env:
        - MATRIX_EVAL="CXX=g++-4.9"
          TESTFOLDER="test/unit/math/mix/mat/fun/[m-z]*"
    - <<: *linux_gcc
      env:
        - MATRIX_EVAL="CXX=g++-4.9"
          TESTFOLDER="test/unit/math/mix/scal test/unit/math/mix/mat/functor test/unit/math/mix/mat/meta test/unit/math/mix/mat/prob test/unit/math/mix/mat/util test/unit/math/mix/mat/vectorize"

 # - TESTFOLDER=test/unit/math/mix # times out on travis

script: ./runTests.py -j2 $TESTFOLDER

sudo: false
dist: trusty
