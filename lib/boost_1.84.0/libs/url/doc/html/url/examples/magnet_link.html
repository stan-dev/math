<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Magnet Link</title>
<link rel="stylesheet" href="../../../../../../doc/src/boostbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.79.1">
<link rel="home" href="../../index.html" title="Chapter 1. Boost.URL">
<link rel="up" href="../examples.html" title="Examples">
<link rel="prev" href="mailto_urls.html" title="mailto URLs">
<link rel="next" href="file_router.html" title="File Router">
<meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<table cellpadding="2" width="100%"><tr>
<td valign="top"><img alt="Boost C++ Libraries" width="277" height="86" src="../../../../../../boost.png"></td>
<td align="center"><a href="../../../../../../index.html">Home</a></td>
<td align="center"><a href="../../../../../../libs/libraries.htm">Libraries</a></td>
<td align="center"><a href="http://www.boost.org/users/people.html">People</a></td>
<td align="center"><a href="http://www.boost.org/users/faq.html">FAQ</a></td>
<td align="center"><a href="../../../../../../more/index.htm">More</a></td>
</tr></table>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="mailto_urls.html"><img src="../../../../../../doc/src/images/prev.png" alt="Prev"></a><a accesskey="u" href="../examples.html"><img src="../../../../../../doc/src/images/up.png" alt="Up"></a><a accesskey="h" href="../../index.html"><img src="../../../../../../doc/src/images/home.png" alt="Home"></a><a accesskey="n" href="file_router.html"><img src="../../../../../../doc/src/images/next.png" alt="Next"></a>
</div>
<div class="section">
<div class="titlepage"><div><div><h3 class="title">
<a name="url.examples.magnet_link"></a><a class="link" href="magnet_link.html" title="Magnet Link">Magnet Link</a>
</h3></div></div></div>
<p>
        <code class="computeroutput"><span class="identifier">magnet</span></code> is a URL scheme for
        identifying files by their content. These files are usually identified by
        cryptographic hash value.
      </p>
<p>
        Magnet links are useful in peer-to-peer file sharing networks because they
        allow resources to be referred to without the need for a continuously available
        host..
      </p>
<p>
        This example parses a magnet link into a new view type and prints its components
        to standard output.
      </p>
<pre class="programlisting"><span class="comment">/*
    This example parses a magnet link into a new
    view type and prints its components to
    standard output.
*/</span>

<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">url</span><span class="special">/</span><span class="identifier">url_view</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">url</span><span class="special">/</span><span class="identifier">url</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">url</span><span class="special">/</span><span class="identifier">optional</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">url</span><span class="special">/</span><span class="identifier">parse</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">url</span><span class="special">/</span><span class="identifier">pct_string_view</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">url</span><span class="special">/</span><span class="identifier">rfc</span><span class="special">/</span><span class="identifier">absolute_uri_rule</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">url</span><span class="special">/</span><span class="identifier">grammar</span><span class="special">/</span><span class="identifier">digit_chars</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">url</span><span class="special">/</span><span class="identifier">grammar</span><span class="special">/</span><span class="identifier">parse</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">core</span><span class="special">/</span><span class="identifier">detail</span><span class="special">/</span><span class="identifier">string_view</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="string">"filter_view.hpp"</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">iostream</span><span class="special">&gt;</span>

<span class="keyword">namespace</span> <span class="identifier">urls</span> <span class="special">=</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">urls</span><span class="special">;</span>
<span class="keyword">namespace</span> <span class="identifier">core</span> <span class="special">=</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">core</span><span class="special">;</span>

<span class="comment">/** Callable to identify a magnet "exact topic"

    This callable evaluates if a query parameter
    represents a magnet "exact topic".

    This callable is used as a filter for
    the topics_view.
 */</span>
<span class="keyword">struct</span> <span class="identifier">is_exact_topic</span>
<span class="special">{</span>
    <span class="keyword">bool</span>
    <span class="keyword">operator</span><span class="special">()(</span><span class="identifier">urls</span><span class="special">::</span><span class="identifier">param_view</span> <span class="identifier">p</span><span class="special">);</span>
<span class="special">};</span>

<span class="comment">/** Callable to identify a magnet url parameter

    This callable evaluates if a query parameter
    has a given key and a url as its value.

    These urls are percent-encoded twice,
    which means we need to decode it once
    before attempting to parse it.

    This callable is used as a filter for
    the keys_view.
 */</span>
<span class="keyword">class</span> <span class="identifier">is_url_with_key</span>
<span class="special">{</span>
    <span class="identifier">core</span><span class="special">::</span><span class="identifier">string_view</span> <span class="identifier">k_</span><span class="special">;</span>
<span class="keyword">public</span><span class="special">:</span>
    <span class="identifier">is_url_with_key</span><span class="special">(</span>
        <span class="identifier">core</span><span class="special">::</span><span class="identifier">string_view</span> <span class="identifier">key</span><span class="special">)</span>
        <span class="special">:</span> <span class="identifier">k_</span><span class="special">(</span><span class="identifier">key</span><span class="special">)</span> <span class="special">{}</span>

    <span class="keyword">bool</span>
    <span class="keyword">operator</span><span class="special">()(</span><span class="identifier">urls</span><span class="special">::</span><span class="identifier">param_view</span> <span class="identifier">p</span><span class="special">);</span>
<span class="special">};</span>

<span class="comment">/** Callable to convert param values to urls

    This callable converts the value of a
    query parameter into a urls::url_view.

    This callable is used as a transform
    function for the topics_view.
 */</span>
<span class="keyword">struct</span> <span class="identifier">param_view_to_url</span>
<span class="special">{</span>
    <span class="identifier">urls</span><span class="special">::</span><span class="identifier">url</span>
    <span class="keyword">operator</span><span class="special">()(</span><span class="identifier">urls</span><span class="special">::</span><span class="identifier">param_view</span> <span class="identifier">p</span><span class="special">);</span>
<span class="special">};</span>

<span class="comment">/** Callable to convert param values to std::string

    This callable converts the value of a
    query parameter into a std::string.

    This callable is used as a transform
    function for the keys_view.
 */</span>
<span class="keyword">struct</span> <span class="identifier">to_decoded_value</span>
<span class="special">{</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span>
    <span class="keyword">operator</span><span class="special">()(</span><span class="identifier">urls</span><span class="special">::</span><span class="identifier">param_view</span> <span class="identifier">p</span><span class="special">)</span>
    <span class="special">{</span>
        <span class="keyword">return</span> <span class="identifier">p</span><span class="special">.</span><span class="identifier">value</span><span class="special">;</span>
    <span class="special">}</span>
<span class="special">};</span>

<span class="comment">/** Callable to convert param values to info_hashes

    This callable converts the value of a
    query parameter into a core::string_view with
    its infohash.

    The infohash hash is a parameter of an
    exact topic field in the magnet link.

    This callable is used as a transform
    function for the info_hashes_view.
 */</span>
<span class="keyword">struct</span> <span class="identifier">param_view_to_infohash</span>
<span class="special">{</span>
    <span class="identifier">core</span><span class="special">::</span><span class="identifier">string_view</span>
    <span class="keyword">operator</span><span class="special">()(</span><span class="identifier">urls</span><span class="special">::</span><span class="identifier">param_view</span> <span class="identifier">p</span><span class="special">);</span>
<span class="special">};</span>

<span class="comment">/** Callable to convert param values to protocols

    This callable converts the value of a
    query parameter into a core::string_view with
    its protocol.

    The protocol is a parameter of an exact
    topic field in the magnet link.

    This callable is used as a transform
    function for the protocols_view.
 */</span>
<span class="keyword">struct</span> <span class="identifier">to_protocol</span>
<span class="special">{</span>
    <span class="identifier">core</span><span class="special">::</span><span class="identifier">string_view</span>
    <span class="keyword">operator</span><span class="special">()(</span><span class="identifier">urls</span><span class="special">::</span><span class="identifier">param_view</span> <span class="identifier">p</span><span class="special">);</span>
<span class="special">};</span>

<span class="keyword">struct</span> <span class="identifier">magnet_link_rule_t</span><span class="special">;</span>

<span class="comment">/** A new url type for magnet links

    This class represents a reference to a
    magnet link.

    Unlike a urls::url_view, which only represents the
    general syntax of urls, a magnet_link_view
    represents a reference to fields that are
    relevant to magnet links, while ignoring
    elements of the general syntax
    that are not relevant to the scheme.

    This allows us to use the general syntax
    parsers to create a representation that
    is more appropriate for the specified scheme
    syntax.

    @par Specification
    @li &lt;a href="https://www.bittorrent.org/beps/bep_0005.html"
        &gt;DHT Protocol&lt;/a&gt;
    @li &lt;a href="https://www.bittorrent.org/beps/bep_0009.html"
        &gt;Extension for Peers to Send Metadata Files&lt;/a&gt;
    @li &lt;a href="https://www.bittorrent.org/beps/bep_0053.html"
        &gt;Magnet URI extension&lt;/a&gt;
    @li &lt;a href="https://en.wikipedia.org/wiki/Magnet_URI_scheme"
        &gt;Magnet URI scheme&lt;/a&gt;

    @par References
    @li &lt;a href="https://github.com/webtorrent/magnet-uri"
        &gt;magnet-uri&lt;/a&gt;

 */</span>
<span class="keyword">class</span> <span class="identifier">magnet_link_view</span>
<span class="special">{</span>
    <span class="identifier">urls</span><span class="special">::</span><span class="identifier">url_view</span> <span class="identifier">u_</span><span class="special">;</span>

<span class="keyword">public</span><span class="special">:</span>
    <span class="comment">/// A view of all exact topics in the magnet_link</span>
    <span class="keyword">using</span> <span class="identifier">topics_view</span> <span class="special">=</span>
        <span class="identifier">filter_view</span><span class="special">&lt;</span>
            <span class="identifier">urls</span><span class="special">::</span><span class="identifier">params_view</span><span class="special">,</span>
            <span class="identifier">urls</span><span class="special">::</span><span class="identifier">url</span><span class="special">,</span>
            <span class="identifier">is_exact_topic</span><span class="special">,</span>
            <span class="identifier">param_view_to_url</span><span class="special">&gt;;</span>

    <span class="comment">/// A view of all info_hashes in the magnet_link</span>
    <span class="keyword">using</span> <span class="identifier">info_hashes_view</span> <span class="special">=</span>
        <span class="identifier">filter_view</span><span class="special">&lt;</span>
            <span class="identifier">urls</span><span class="special">::</span><span class="identifier">params_view</span><span class="special">,</span>
            <span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span><span class="special">,</span>
            <span class="identifier">is_exact_topic</span><span class="special">,</span>
            <span class="identifier">param_view_to_infohash</span><span class="special">&gt;;</span>

    <span class="comment">/// A view of all protocols in the magnet_link</span>
    <span class="keyword">using</span> <span class="identifier">protocols_view</span> <span class="special">=</span>
        <span class="identifier">filter_view</span><span class="special">&lt;</span>
            <span class="identifier">urls</span><span class="special">::</span><span class="identifier">params_view</span><span class="special">,</span>
            <span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span><span class="special">,</span>
            <span class="identifier">is_exact_topic</span><span class="special">,</span>
            <span class="identifier">to_protocol</span><span class="special">&gt;;</span>

    <span class="comment">/** A view of all urls with the specified key in the magnet_link

        A number of fields in a magnet link refer
        to a list of urls with the same query
        parameter keys.
    */</span>
    <span class="keyword">using</span> <span class="identifier">keys_view</span> <span class="special">=</span>
        <span class="identifier">filter_view</span><span class="special">&lt;</span>
            <span class="identifier">urls</span><span class="special">::</span><span class="identifier">params_view</span><span class="special">,</span>
            <span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span><span class="special">,</span>
            <span class="identifier">is_url_with_key</span><span class="special">,</span>
            <span class="identifier">to_decoded_value</span><span class="special">&gt;;</span>

    <span class="comment">/** URNs to the file or files hashes

        An exact topic is the main field of a
        magnet link. A magnet link must contain
        one or more exact topics with the query
        key "xt" or ["xt.1", "xt.2", ...].

        The value of each exact topic is a URN
        representing the file hash and the protocol
        to access the file.

        @return A view of all exact topic URNs in the link
    */</span>
    <span class="identifier">topics_view</span>
    <span class="identifier">exact_topics</span><span class="special">()</span> <span class="keyword">const</span> <span class="keyword">noexcept</span><span class="special">;</span>

    <span class="comment">/** Info hash of the file or files

        @return A view of all info hashes in exact topics
    */</span>
    <span class="identifier">info_hashes_view</span>
    <span class="identifier">info_hashes</span><span class="special">()</span> <span class="keyword">const</span> <span class="keyword">noexcept</span><span class="special">;</span>

    <span class="comment">/** Protocol of the exact topics

        @return A view of all protocols in exact topics
    */</span>
    <span class="identifier">protocols_view</span>
    <span class="identifier">protocols</span><span class="special">()</span> <span class="keyword">const</span> <span class="keyword">noexcept</span><span class="special">;</span>

    <span class="comment">/** Return view of address trackers

        A tracker URL is used to obtain resources
        for BitTorrent downloads.

        @return A view of all address trackers in the link
    */</span>
    <span class="identifier">keys_view</span>
    <span class="identifier">address_trackers</span><span class="special">()</span> <span class="keyword">const</span><span class="special">;</span>

    <span class="comment">/** Return view of exact sources

        An exact source URL is a direct download
        link to the file.

        @return A view of all exact sources
    */</span>
    <span class="identifier">keys_view</span>
    <span class="identifier">exact_sources</span><span class="special">()</span> <span class="keyword">const</span><span class="special">;</span>

    <span class="comment">/** Return view of acceptable sources

        An acceptable source URL is a direct
        download link to the file that can be
        used as a fallback for exact sources.

        @return A view of all acceptable sources
    */</span>
    <span class="identifier">keys_view</span>
    <span class="identifier">acceptable_sources</span><span class="special">()</span> <span class="keyword">const</span><span class="special">;</span>

    <span class="comment">/** Return keyword topic

        The keyword topic is the search keywords
        to use in P2P networks.

        @par Example
        kt=martin+luther+king+mp3

        @return Keyword topic
    */</span>
    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">optional</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span><span class="special">&gt;</span>
    <span class="identifier">keyword_topic</span><span class="special">()</span> <span class="keyword">const</span> <span class="keyword">noexcept</span><span class="special">;</span>

    <span class="comment">/** Return manifest topics

        This function returns a link to the
        metafile that contains a list of magneto.

        @par Specification
        @li &lt;a href="http://rakjar.de/gnuticles/MAGMA-Specsv22.txt"
            &gt;MAGnet MAnifest&lt;/a&gt;

        @return A view of manifest topics
    */</span>
    <span class="identifier">keys_view</span>
    <span class="identifier">manifest_topics</span><span class="special">()</span> <span class="keyword">const</span><span class="special">;</span>

    <span class="comment">/** Return display name

        This function returns a filename to
        display to the user. This field is
        only used for convenience.

        @par Specification
        @li &lt;a href="http://rakjar.de/gnuticles/MAGMA-Specsv22.txt"
            &gt;MAGnet MAnifest&lt;/a&gt;

        @return Display name
    */</span>
    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">optional</span><span class="special">&lt;</span><span class="identifier">urls</span><span class="special">::</span><span class="identifier">pct_string_view</span><span class="special">&gt;</span>
    <span class="identifier">display_name</span><span class="special">()</span> <span class="keyword">const</span> <span class="keyword">noexcept</span><span class="special">;</span>

    <span class="comment">/** Return web seed

        The web seed represents the payload data
        served over HTTP(S).

        @return Web seed
    */</span>
    <span class="identifier">keys_view</span>
    <span class="identifier">web_seed</span><span class="special">()</span> <span class="keyword">const</span><span class="special">;</span>

    <span class="comment">/** Return extra supplement parameter

        This function returns informal options
        and parameters of the magnet link.

        Query parameters whose keys have the
        prefix "x." are used in magnet links
        for extra parameters. These names
        are guaranteed to never be standardized.

        @par Example
        x.parameter_name=parameter_data

        @return Web seed
    */</span>
    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">optional</span><span class="special">&lt;</span><span class="identifier">urls</span><span class="special">::</span><span class="identifier">pct_string_view</span><span class="special">&gt;</span>
    <span class="identifier">param</span><span class="special">(</span><span class="identifier">core</span><span class="special">::</span><span class="identifier">string_view</span> <span class="identifier">key</span><span class="special">)</span> <span class="keyword">const</span> <span class="keyword">noexcept</span><span class="special">;</span>

    <span class="keyword">friend</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">ostream</span><span class="special">&amp;</span>
    <span class="keyword">operator</span><span class="special">&lt;&lt;(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">ostream</span><span class="special">&amp;</span> <span class="identifier">os</span><span class="special">,</span> <span class="identifier">magnet_link_view</span> <span class="identifier">m</span><span class="special">)</span>
    <span class="special">{</span>
        <span class="keyword">return</span> <span class="identifier">os</span> <span class="special">&lt;&lt;</span> <span class="identifier">m</span><span class="special">.</span><span class="identifier">u_</span><span class="special">;</span>
    <span class="special">}</span>

<span class="keyword">private</span><span class="special">:</span>
    <span class="comment">// get a query parameter as a urls::pct_string_view</span>
    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">optional</span><span class="special">&lt;</span><span class="identifier">urls</span><span class="special">::</span><span class="identifier">pct_string_view</span><span class="special">&gt;</span>
    <span class="identifier">encoded_param</span><span class="special">(</span><span class="identifier">core</span><span class="special">::</span><span class="identifier">string_view</span> <span class="identifier">key</span><span class="special">)</span> <span class="keyword">const</span> <span class="keyword">noexcept</span><span class="special">;</span>

    <span class="comment">// get a query parameter as a urls::url_view</span>
    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">optional</span><span class="special">&lt;</span><span class="identifier">urls</span><span class="special">::</span><span class="identifier">url_view</span><span class="special">&gt;</span>
    <span class="identifier">url_param</span><span class="special">(</span><span class="identifier">core</span><span class="special">::</span><span class="identifier">string_view</span> <span class="identifier">key</span><span class="special">)</span> <span class="keyword">const</span> <span class="keyword">noexcept</span><span class="special">;</span>

    <span class="keyword">friend</span> <span class="identifier">magnet_link_rule_t</span><span class="special">;</span>
<span class="special">};</span>

<span class="keyword">bool</span>
<span class="identifier">is_exact_topic</span><span class="special">::</span>
<span class="keyword">operator</span><span class="special">()(</span><span class="identifier">urls</span><span class="special">::</span><span class="identifier">param_view</span> <span class="identifier">p</span><span class="special">)</span>
<span class="special">{</span>
    <span class="comment">// These comparisons use the lazy</span>
    <span class="comment">// operator== for urls::pct_string_view</span>
    <span class="comment">// For instance, the comparison also works</span>
    <span class="comment">// if the underlying key is "%78%74"/</span>
    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">p</span><span class="special">.</span><span class="identifier">key</span> <span class="special">==</span> <span class="string">"xt"</span><span class="special">)</span>
        <span class="keyword">return</span> <span class="keyword">true</span><span class="special">;</span>
    <span class="keyword">return</span>
        <span class="identifier">p</span><span class="special">.</span><span class="identifier">key</span><span class="special">.</span><span class="identifier">size</span><span class="special">()</span> <span class="special">&gt;</span> <span class="number">3</span> <span class="special">&amp;&amp;</span>
        <span class="special">*</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">next</span><span class="special">(</span><span class="identifier">p</span><span class="special">.</span><span class="identifier">key</span><span class="special">.</span><span class="identifier">begin</span><span class="special">(),</span> <span class="number">0</span><span class="special">)</span> <span class="special">==</span> <span class="char">'x'</span> <span class="special">&amp;&amp;</span>
        <span class="special">*</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">next</span><span class="special">(</span><span class="identifier">p</span><span class="special">.</span><span class="identifier">key</span><span class="special">.</span><span class="identifier">begin</span><span class="special">(),</span> <span class="number">1</span><span class="special">)</span> <span class="special">==</span> <span class="char">'t'</span> <span class="special">&amp;&amp;</span>
        <span class="special">*</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">next</span><span class="special">(</span><span class="identifier">p</span><span class="special">.</span><span class="identifier">key</span><span class="special">.</span><span class="identifier">begin</span><span class="special">(),</span> <span class="number">2</span><span class="special">)</span> <span class="special">==</span> <span class="char">'.'</span> <span class="special">&amp;&amp;</span>
        <span class="identifier">std</span><span class="special">::</span><span class="identifier">all_of</span><span class="special">(</span>
            <span class="identifier">std</span><span class="special">::</span><span class="identifier">next</span><span class="special">(</span><span class="identifier">p</span><span class="special">.</span><span class="identifier">key</span><span class="special">.</span><span class="identifier">begin</span><span class="special">(),</span> <span class="number">3</span><span class="special">),</span>
            <span class="identifier">p</span><span class="special">.</span><span class="identifier">key</span><span class="special">.</span><span class="identifier">end</span><span class="special">(),</span>
            <span class="identifier">urls</span><span class="special">::</span><span class="identifier">grammar</span><span class="special">::</span><span class="identifier">digit_chars</span><span class="special">);</span>
<span class="special">}</span>

<span class="keyword">bool</span>
<span class="identifier">is_url_with_key</span><span class="special">::</span>
<span class="keyword">operator</span><span class="special">()(</span><span class="identifier">urls</span><span class="special">::</span><span class="identifier">param_view</span> <span class="identifier">p</span><span class="special">)</span>
<span class="special">{</span>
    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">p</span><span class="special">.</span><span class="identifier">key</span> <span class="special">!=</span> <span class="identifier">k_</span><span class="special">)</span>
        <span class="keyword">return</span> <span class="keyword">false</span><span class="special">;</span>
    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">system</span><span class="special">::</span><span class="identifier">error_code</span> <span class="identifier">ec</span><span class="special">;</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span> <span class="identifier">buf</span><span class="special">(</span>
        <span class="identifier">p</span><span class="special">.</span><span class="identifier">value</span><span class="special">.</span><span class="identifier">begin</span><span class="special">(),</span> <span class="identifier">p</span><span class="special">.</span><span class="identifier">value</span><span class="special">.</span><span class="identifier">end</span><span class="special">());</span>
    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">ec</span><span class="special">.</span><span class="identifier">failed</span><span class="special">())</span>
        <span class="keyword">return</span> <span class="keyword">false</span><span class="special">;</span>
    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">system</span><span class="special">::</span><span class="identifier">result</span><span class="special">&lt;</span><span class="identifier">urls</span><span class="special">::</span><span class="identifier">url_view</span><span class="special">&gt;</span> <span class="identifier">r</span> <span class="special">=</span>
        <span class="identifier">urls</span><span class="special">::</span><span class="identifier">parse_uri</span><span class="special">(</span><span class="identifier">buf</span><span class="special">);</span>
    <span class="keyword">return</span> <span class="identifier">r</span><span class="special">.</span><span class="identifier">has_value</span><span class="special">();</span>
<span class="special">}</span>

<span class="identifier">urls</span><span class="special">::</span><span class="identifier">url</span>
<span class="identifier">param_view_to_url</span><span class="special">::</span>
<span class="keyword">operator</span><span class="special">()(</span><span class="identifier">urls</span><span class="special">::</span><span class="identifier">param_view</span> <span class="identifier">p</span><span class="special">)</span>
<span class="special">{</span>
    <span class="comment">// `param_view_to_url` is used in topics_view,</span>
    <span class="comment">// where the URL is not</span>
    <span class="comment">// percent-encoded twice.</span>
    <span class="comment">// Thus, we can already parse the</span>
    <span class="comment">// encoded value.</span>
    <span class="keyword">auto</span> <span class="identifier">ur</span> <span class="special">=</span>
        <span class="identifier">urls</span><span class="special">::</span><span class="identifier">parse_uri</span><span class="special">(</span><span class="identifier">p</span><span class="special">.</span><span class="identifier">value</span><span class="special">);</span>
    <span class="identifier">BOOST_ASSERT</span><span class="special">(</span><span class="identifier">ur</span><span class="special">);</span>
    <span class="identifier">urls</span><span class="special">::</span><span class="identifier">url</span> <span class="identifier">u</span> <span class="special">=</span> <span class="special">*</span><span class="identifier">ur</span><span class="special">;</span>
    <span class="keyword">return</span> <span class="identifier">u</span><span class="special">;</span>
<span class="special">}</span>

<span class="identifier">core</span><span class="special">::</span><span class="identifier">string_view</span>
<span class="identifier">param_view_to_infohash</span><span class="special">::</span>
<span class="keyword">operator</span><span class="special">()(</span><span class="identifier">urls</span><span class="special">::</span><span class="identifier">param_view</span> <span class="identifier">p</span><span class="special">)</span>
<span class="special">{</span>
    <span class="identifier">urls</span><span class="special">::</span><span class="identifier">url_view</span> <span class="identifier">topic</span> <span class="special">=</span>
        <span class="identifier">urls</span><span class="special">::</span><span class="identifier">parse_uri</span><span class="special">(</span><span class="identifier">p</span><span class="special">.</span><span class="identifier">value</span><span class="special">).</span><span class="identifier">value</span><span class="special">();</span>
    <span class="identifier">core</span><span class="special">::</span><span class="identifier">string_view</span> <span class="identifier">t</span> <span class="special">=</span> <span class="identifier">topic</span><span class="special">.</span><span class="identifier">encoded_path</span><span class="special">();</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">size_t</span> <span class="identifier">pos</span> <span class="special">=</span> <span class="identifier">t</span><span class="special">.</span><span class="identifier">find_last_of</span><span class="special">(</span><span class="char">':'</span><span class="special">);</span>
    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">pos</span> <span class="special">!=</span> <span class="identifier">core</span><span class="special">::</span><span class="identifier">string_view</span><span class="special">::</span><span class="identifier">npos</span><span class="special">)</span>
        <span class="keyword">return</span> <span class="identifier">t</span><span class="special">.</span><span class="identifier">substr</span><span class="special">(</span><span class="identifier">pos</span> <span class="special">+</span> <span class="number">1</span><span class="special">);</span>
    <span class="keyword">return</span> <span class="identifier">t</span><span class="special">;</span>
<span class="special">}</span>

<span class="identifier">core</span><span class="special">::</span><span class="identifier">string_view</span>
<span class="identifier">to_protocol</span><span class="special">::</span>
<span class="keyword">operator</span><span class="special">()(</span><span class="identifier">urls</span><span class="special">::</span><span class="identifier">param_view</span> <span class="identifier">p</span><span class="special">)</span>
<span class="special">{</span>
    <span class="identifier">urls</span><span class="special">::</span><span class="identifier">url_view</span> <span class="identifier">topic</span> <span class="special">=</span>
        <span class="identifier">urls</span><span class="special">::</span><span class="identifier">parse_uri</span><span class="special">(</span><span class="identifier">p</span><span class="special">.</span><span class="identifier">value</span><span class="special">).</span><span class="identifier">value</span><span class="special">();</span>
    <span class="identifier">core</span><span class="special">::</span><span class="identifier">string_view</span> <span class="identifier">t</span> <span class="special">=</span> <span class="identifier">topic</span><span class="special">.</span><span class="identifier">encoded_path</span><span class="special">();</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">size_t</span> <span class="identifier">pos</span> <span class="special">=</span> <span class="identifier">t</span><span class="special">.</span><span class="identifier">find_last_of</span><span class="special">(</span><span class="char">':'</span><span class="special">);</span>
    <span class="keyword">return</span> <span class="identifier">t</span><span class="special">.</span><span class="identifier">substr</span><span class="special">(</span><span class="number">0</span><span class="special">,</span> <span class="identifier">pos</span><span class="special">);</span>
<span class="special">}</span>

<span class="keyword">auto</span>
<span class="identifier">magnet_link_view</span><span class="special">::</span><span class="identifier">exact_topics</span><span class="special">()</span> <span class="keyword">const</span> <span class="keyword">noexcept</span>
    <span class="special">-&gt;</span> <span class="identifier">topics_view</span>
<span class="special">{</span>
    <span class="keyword">return</span> <span class="special">{</span><span class="identifier">u_</span><span class="special">.</span><span class="identifier">params</span><span class="special">()};</span>
<span class="special">}</span>

<span class="keyword">auto</span>
<span class="identifier">magnet_link_view</span><span class="special">::</span><span class="identifier">info_hashes</span><span class="special">()</span> <span class="keyword">const</span> <span class="keyword">noexcept</span>
    <span class="special">-&gt;</span> <span class="identifier">info_hashes_view</span>
<span class="special">{</span>
    <span class="keyword">return</span> <span class="special">{</span><span class="identifier">u_</span><span class="special">.</span><span class="identifier">params</span><span class="special">()};</span>
<span class="special">}</span>

<span class="keyword">auto</span>
<span class="identifier">magnet_link_view</span><span class="special">::</span><span class="identifier">protocols</span><span class="special">()</span> <span class="keyword">const</span> <span class="keyword">noexcept</span>
    <span class="special">-&gt;</span> <span class="identifier">protocols_view</span>
<span class="special">{</span>
    <span class="keyword">return</span> <span class="special">{</span><span class="identifier">u_</span><span class="special">.</span><span class="identifier">params</span><span class="special">()};</span>
<span class="special">}</span>

<span class="keyword">auto</span>
<span class="identifier">magnet_link_view</span><span class="special">::</span><span class="identifier">address_trackers</span><span class="special">()</span> <span class="keyword">const</span>
    <span class="special">-&gt;</span> <span class="identifier">keys_view</span>
<span class="special">{</span>
    <span class="keyword">return</span> <span class="special">{</span>
        <span class="identifier">u_</span><span class="special">.</span><span class="identifier">params</span><span class="special">(),</span>
        <span class="identifier">is_url_with_key</span><span class="special">{</span><span class="string">"tr"</span><span class="special">}};</span>
<span class="special">}</span>

<span class="keyword">auto</span>
<span class="identifier">magnet_link_view</span><span class="special">::</span><span class="identifier">exact_sources</span><span class="special">()</span> <span class="keyword">const</span>
    <span class="special">-&gt;</span> <span class="identifier">keys_view</span>
<span class="special">{</span>
    <span class="keyword">return</span> <span class="special">{</span>
        <span class="identifier">u_</span><span class="special">.</span><span class="identifier">params</span><span class="special">(),</span>
        <span class="identifier">is_url_with_key</span><span class="special">{</span><span class="string">"xs"</span><span class="special">}};</span>
<span class="special">}</span>

<span class="keyword">auto</span>
<span class="identifier">magnet_link_view</span><span class="special">::</span><span class="identifier">acceptable_sources</span><span class="special">()</span> <span class="keyword">const</span>
    <span class="special">-&gt;</span> <span class="identifier">keys_view</span>
<span class="special">{</span>
    <span class="keyword">return</span> <span class="special">{</span>
        <span class="identifier">u_</span><span class="special">.</span><span class="identifier">params</span><span class="special">(),</span>
        <span class="identifier">is_url_with_key</span><span class="special">{</span><span class="string">"as"</span><span class="special">}};</span>
<span class="special">}</span>

<span class="identifier">boost</span><span class="special">::</span><span class="identifier">optional</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span><span class="special">&gt;</span>
<span class="identifier">magnet_link_view</span><span class="special">::</span><span class="identifier">keyword_topic</span><span class="special">()</span> <span class="keyword">const</span> <span class="keyword">noexcept</span>
<span class="special">{</span>
    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">optional</span><span class="special">&lt;</span><span class="identifier">urls</span><span class="special">::</span><span class="identifier">pct_string_view</span><span class="special">&gt;</span> <span class="identifier">o</span> <span class="special">=</span>
        <span class="identifier">encoded_param</span><span class="special">(</span><span class="string">"kt"</span><span class="special">);</span>
    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">o</span><span class="special">)</span>
        <span class="keyword">return</span> <span class="identifier">o</span><span class="special">-&gt;</span><span class="identifier">decode</span><span class="special">();</span>
    <span class="keyword">return</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">none</span><span class="special">;</span>
<span class="special">}</span>

<span class="keyword">auto</span>
<span class="identifier">magnet_link_view</span><span class="special">::</span><span class="identifier">manifest_topics</span><span class="special">()</span> <span class="keyword">const</span>
    <span class="special">-&gt;</span> <span class="identifier">keys_view</span>
<span class="special">{</span>
    <span class="keyword">return</span> <span class="special">{</span>
        <span class="identifier">u_</span><span class="special">.</span><span class="identifier">params</span><span class="special">(),</span>
        <span class="identifier">is_url_with_key</span><span class="special">{</span><span class="string">"mt"</span><span class="special">}};</span>
<span class="special">}</span>

<span class="identifier">boost</span><span class="special">::</span><span class="identifier">optional</span><span class="special">&lt;</span><span class="identifier">urls</span><span class="special">::</span><span class="identifier">pct_string_view</span><span class="special">&gt;</span>
<span class="identifier">magnet_link_view</span><span class="special">::</span><span class="identifier">display_name</span><span class="special">()</span> <span class="keyword">const</span> <span class="keyword">noexcept</span>
<span class="special">{</span>
    <span class="keyword">return</span> <span class="identifier">encoded_param</span><span class="special">(</span><span class="string">"dn"</span><span class="special">);</span>
<span class="special">}</span>

<span class="keyword">auto</span>
<span class="identifier">magnet_link_view</span><span class="special">::</span><span class="identifier">web_seed</span><span class="special">()</span> <span class="keyword">const</span>
    <span class="special">-&gt;</span> <span class="identifier">keys_view</span>
<span class="special">{</span>
    <span class="keyword">return</span> <span class="special">{</span>
        <span class="identifier">u_</span><span class="special">.</span><span class="identifier">params</span><span class="special">(),</span>
        <span class="identifier">is_url_with_key</span><span class="special">{</span><span class="string">"ws"</span><span class="special">}};</span>
<span class="special">}</span>

<span class="identifier">boost</span><span class="special">::</span><span class="identifier">optional</span><span class="special">&lt;</span><span class="identifier">urls</span><span class="special">::</span><span class="identifier">pct_string_view</span><span class="special">&gt;</span>
<span class="identifier">magnet_link_view</span><span class="special">::</span><span class="identifier">param</span><span class="special">(</span><span class="identifier">core</span><span class="special">::</span><span class="identifier">string_view</span> <span class="identifier">key</span><span class="special">)</span> <span class="keyword">const</span> <span class="keyword">noexcept</span>
<span class="special">{</span>
    <span class="identifier">urls</span><span class="special">::</span><span class="identifier">params_view</span> <span class="identifier">ps</span> <span class="special">=</span> <span class="identifier">u_</span><span class="special">.</span><span class="identifier">params</span><span class="special">();</span>
    <span class="keyword">auto</span> <span class="identifier">it</span> <span class="special">=</span> <span class="identifier">ps</span><span class="special">.</span><span class="identifier">begin</span><span class="special">();</span>
    <span class="keyword">auto</span> <span class="identifier">end</span> <span class="special">=</span> <span class="identifier">ps</span><span class="special">.</span><span class="identifier">end</span><span class="special">();</span>
    <span class="keyword">while</span> <span class="special">(</span><span class="identifier">it</span> <span class="special">!=</span> <span class="identifier">end</span><span class="special">)</span>
    <span class="special">{</span>
        <span class="identifier">urls</span><span class="special">::</span><span class="identifier">param_view</span> <span class="identifier">p</span> <span class="special">=</span> <span class="special">*</span><span class="identifier">it</span><span class="special">;</span>
        <span class="keyword">if</span> <span class="special">(</span><span class="identifier">p</span><span class="special">.</span><span class="identifier">key</span><span class="special">.</span><span class="identifier">size</span><span class="special">()</span> <span class="special">&lt;</span> <span class="number">2</span><span class="special">)</span>
        <span class="special">{</span>
            <span class="special">++</span><span class="identifier">it</span><span class="special">;</span>
            <span class="keyword">continue</span><span class="special">;</span>
        <span class="special">}</span>
        <span class="keyword">auto</span> <span class="identifier">first</span> <span class="special">=</span> <span class="identifier">p</span><span class="special">.</span><span class="identifier">key</span><span class="special">.</span><span class="identifier">begin</span><span class="special">();</span>
        <span class="keyword">auto</span> <span class="identifier">mid</span> <span class="special">=</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">next</span><span class="special">(</span><span class="identifier">p</span><span class="special">.</span><span class="identifier">key</span><span class="special">.</span><span class="identifier">begin</span><span class="special">(),</span> <span class="number">2</span><span class="special">);</span>
        <span class="keyword">auto</span> <span class="identifier">last</span> <span class="special">=</span> <span class="identifier">p</span><span class="special">.</span><span class="identifier">key</span><span class="special">.</span><span class="identifier">end</span><span class="special">();</span>
        <span class="identifier">urls</span><span class="special">::</span><span class="identifier">pct_string_view</span> <span class="identifier">prefix</span><span class="special">(</span>
            <span class="identifier">core</span><span class="special">::</span><span class="identifier">string_view</span><span class="special">(</span><span class="identifier">first</span><span class="special">,</span> <span class="identifier">mid</span><span class="special">));</span>
        <span class="identifier">urls</span><span class="special">::</span><span class="identifier">pct_string_view</span> <span class="identifier">suffix</span><span class="special">(</span>
            <span class="identifier">core</span><span class="special">::</span><span class="identifier">string_view</span><span class="special">(</span><span class="identifier">mid</span><span class="special">,</span> <span class="identifier">last</span><span class="special">));</span>
        <span class="keyword">if</span> <span class="special">(</span><span class="identifier">prefix</span> <span class="special">==</span> <span class="string">"x."</span> <span class="special">&amp;&amp;</span>
            <span class="identifier">suffix</span> <span class="special">==</span> <span class="identifier">key</span> <span class="special">&amp;&amp;</span>
            <span class="identifier">p</span><span class="special">.</span><span class="identifier">has_value</span><span class="special">)</span>
            <span class="keyword">return</span> <span class="identifier">urls</span><span class="special">::</span><span class="identifier">pct_string_view</span><span class="special">(</span><span class="identifier">p</span><span class="special">.</span><span class="identifier">value</span><span class="special">);</span>
        <span class="special">++</span><span class="identifier">it</span><span class="special">;</span>
    <span class="special">}</span>
    <span class="keyword">return</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">none</span><span class="special">;</span>
<span class="special">}</span>

<span class="identifier">boost</span><span class="special">::</span><span class="identifier">optional</span><span class="special">&lt;</span><span class="identifier">urls</span><span class="special">::</span><span class="identifier">pct_string_view</span><span class="special">&gt;</span>
<span class="identifier">magnet_link_view</span><span class="special">::</span><span class="identifier">encoded_param</span><span class="special">(</span><span class="identifier">core</span><span class="special">::</span><span class="identifier">string_view</span> <span class="identifier">key</span><span class="special">)</span> <span class="keyword">const</span> <span class="keyword">noexcept</span>
<span class="special">{</span>
    <span class="identifier">urls</span><span class="special">::</span><span class="identifier">params_encoded_view</span> <span class="identifier">ps</span> <span class="special">=</span> <span class="identifier">u_</span><span class="special">.</span><span class="identifier">encoded_params</span><span class="special">();</span>
    <span class="keyword">auto</span> <span class="identifier">it</span> <span class="special">=</span> <span class="identifier">ps</span><span class="special">.</span><span class="identifier">find</span><span class="special">(</span><span class="identifier">key</span><span class="special">);</span>
    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">it</span> <span class="special">!=</span> <span class="identifier">ps</span><span class="special">.</span><span class="identifier">end</span><span class="special">()</span> <span class="special">&amp;&amp;</span> <span class="special">(*</span><span class="identifier">it</span><span class="special">).</span><span class="identifier">has_value</span><span class="special">)</span>
        <span class="keyword">return</span> <span class="identifier">urls</span><span class="special">::</span><span class="identifier">pct_string_view</span><span class="special">((*</span><span class="identifier">it</span><span class="special">).</span><span class="identifier">value</span><span class="special">);</span>
    <span class="keyword">return</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">none</span><span class="special">;</span>
<span class="special">}</span>

<span class="identifier">boost</span><span class="special">::</span><span class="identifier">optional</span><span class="special">&lt;</span><span class="identifier">urls</span><span class="special">::</span><span class="identifier">url_view</span><span class="special">&gt;</span>
<span class="identifier">magnet_link_view</span><span class="special">::</span><span class="identifier">url_param</span><span class="special">(</span><span class="identifier">core</span><span class="special">::</span><span class="identifier">string_view</span> <span class="identifier">key</span><span class="special">)</span> <span class="keyword">const</span> <span class="keyword">noexcept</span>
<span class="special">{</span>
    <span class="identifier">urls</span><span class="special">::</span><span class="identifier">params_encoded_view</span> <span class="identifier">ps</span> <span class="special">=</span> <span class="identifier">u_</span><span class="special">.</span><span class="identifier">encoded_params</span><span class="special">();</span>
    <span class="keyword">auto</span> <span class="identifier">it</span> <span class="special">=</span> <span class="identifier">ps</span><span class="special">.</span><span class="identifier">find</span><span class="special">(</span><span class="identifier">key</span><span class="special">);</span>
    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">it</span> <span class="special">!=</span> <span class="identifier">ps</span><span class="special">.</span><span class="identifier">end</span><span class="special">()</span> <span class="special">&amp;&amp;</span> <span class="special">(*</span><span class="identifier">it</span><span class="special">).</span><span class="identifier">has_value</span><span class="special">)</span>
    <span class="special">{</span>
        <span class="identifier">boost</span><span class="special">::</span><span class="identifier">system</span><span class="special">::</span><span class="identifier">result</span><span class="special">&lt;</span><span class="identifier">urls</span><span class="special">::</span><span class="identifier">url_view</span><span class="special">&gt;</span> <span class="identifier">r</span> <span class="special">=</span>
            <span class="identifier">urls</span><span class="special">::</span><span class="identifier">parse_uri</span><span class="special">((*</span><span class="identifier">it</span><span class="special">).</span><span class="identifier">value</span><span class="special">);</span>
        <span class="keyword">if</span> <span class="special">(</span><span class="identifier">r</span><span class="special">)</span>
            <span class="keyword">return</span> <span class="special">*</span><span class="identifier">r</span><span class="special">;</span>
    <span class="special">}</span>
    <span class="keyword">return</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">none</span><span class="special">;</span>
<span class="special">}</span>

<span class="comment">/** Rule to match a magnet link
*/</span>
<span class="keyword">struct</span> <span class="identifier">magnet_link_rule_t</span>
<span class="special">{</span>
    <span class="comment">/// Value type returned by the rule</span>
    <span class="keyword">using</span> <span class="identifier">value_type</span> <span class="special">=</span> <span class="identifier">magnet_link_view</span><span class="special">;</span>

    <span class="comment">/// Parse a sequence of characters into a magnet_link_view</span>
    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">system</span><span class="special">::</span><span class="identifier">result</span><span class="special">&lt;</span> <span class="identifier">value_type</span> <span class="special">&gt;</span>
    <span class="identifier">parse</span><span class="special">(</span> <span class="keyword">char</span> <span class="keyword">const</span><span class="special">*&amp;</span> <span class="identifier">it</span><span class="special">,</span> <span class="keyword">char</span> <span class="keyword">const</span><span class="special">*</span> <span class="identifier">end</span> <span class="special">)</span> <span class="keyword">const</span> <span class="keyword">noexcept</span><span class="special">;</span>
<span class="special">};</span>

<span class="keyword">auto</span>
<span class="identifier">magnet_link_rule_t</span><span class="special">::</span><span class="identifier">parse</span><span class="special">(</span>
    <span class="keyword">char</span> <span class="keyword">const</span><span class="special">*&amp;</span> <span class="identifier">it</span><span class="special">,</span>
    <span class="keyword">char</span> <span class="keyword">const</span><span class="special">*</span> <span class="identifier">end</span> <span class="special">)</span> <span class="keyword">const</span> <span class="keyword">noexcept</span>
    <span class="special">-&gt;</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">system</span><span class="special">::</span><span class="identifier">result</span><span class="special">&lt;</span> <span class="identifier">value_type</span> <span class="special">&gt;</span>
<span class="special">{</span>
    <span class="comment">// 1) Parse url with the general uri syntax</span>
    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">system</span><span class="special">::</span><span class="identifier">result</span><span class="special">&lt;</span><span class="identifier">urls</span><span class="special">::</span><span class="identifier">url_view</span><span class="special">&gt;</span> <span class="identifier">r</span> <span class="special">=</span>
        <span class="identifier">urls</span><span class="special">::</span><span class="identifier">grammar</span><span class="special">::</span><span class="identifier">parse</span><span class="special">(</span><span class="identifier">it</span><span class="special">,</span> <span class="identifier">end</span><span class="special">,</span> <span class="identifier">urls</span><span class="special">::</span><span class="identifier">absolute_uri_rule</span><span class="special">);</span>
    <span class="keyword">if</span><span class="special">(!</span><span class="identifier">r</span><span class="special">)</span>
        <span class="keyword">return</span> <span class="identifier">urls</span><span class="special">::</span><span class="identifier">grammar</span><span class="special">::</span><span class="identifier">error</span><span class="special">::</span><span class="identifier">invalid</span><span class="special">;</span>
    <span class="identifier">magnet_link_view</span> <span class="identifier">m</span><span class="special">;</span>
    <span class="identifier">m</span><span class="special">.</span><span class="identifier">u_</span> <span class="special">=</span> <span class="special">*</span><span class="identifier">r</span><span class="special">;</span>

    <span class="comment">// 2) Check if exact topics are valid urls</span>
    <span class="comment">// and that we have at least one. This is the</span>
    <span class="comment">// only mandatory field in magnet links.</span>
    <span class="keyword">auto</span> <span class="identifier">ps</span> <span class="special">=</span> <span class="identifier">m</span><span class="special">.</span><span class="identifier">u_</span><span class="special">.</span><span class="identifier">params</span><span class="special">();</span>
    <span class="keyword">auto</span> <span class="identifier">pit</span> <span class="special">=</span> <span class="identifier">ps</span><span class="special">.</span><span class="identifier">begin</span><span class="special">();</span>
    <span class="keyword">auto</span> <span class="identifier">pend</span> <span class="special">=</span> <span class="identifier">ps</span><span class="special">.</span><span class="identifier">end</span><span class="special">();</span>
    <span class="identifier">pit</span> <span class="special">=</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">find_if</span><span class="special">(</span><span class="identifier">pit</span><span class="special">,</span> <span class="identifier">pend</span><span class="special">,</span> <span class="identifier">is_exact_topic</span><span class="special">{});</span>
    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">pit</span> <span class="special">==</span> <span class="identifier">pend</span><span class="special">)</span>
    <span class="special">{</span>
        <span class="comment">// no exact topic in the magnet link</span>
        <span class="keyword">return</span> <span class="identifier">urls</span><span class="special">::</span><span class="identifier">grammar</span><span class="special">::</span><span class="identifier">error</span><span class="special">::</span><span class="identifier">invalid</span><span class="special">;</span>
    <span class="special">}</span>

    <span class="comment">// all topics should parse as valid urls</span>
    <span class="keyword">if</span> <span class="special">(!</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">all_of</span><span class="special">(</span><span class="identifier">pit</span><span class="special">,</span> <span class="identifier">pend</span><span class="special">,</span> <span class="special">[](</span>
        <span class="identifier">urls</span><span class="special">::</span><span class="identifier">param_view</span> <span class="identifier">p</span><span class="special">)</span>
    <span class="special">{</span>
        <span class="keyword">if</span> <span class="special">(!</span><span class="identifier">is_exact_topic</span><span class="special">{}(</span><span class="identifier">p</span><span class="special">))</span>
            <span class="keyword">return</span> <span class="keyword">true</span><span class="special">;</span>
        <span class="identifier">boost</span><span class="special">::</span><span class="identifier">system</span><span class="special">::</span><span class="identifier">result</span><span class="special">&lt;</span><span class="identifier">urls</span><span class="special">::</span><span class="identifier">url_view</span><span class="special">&gt;</span> <span class="identifier">u</span> <span class="special">=</span>
            <span class="identifier">urls</span><span class="special">::</span><span class="identifier">parse_uri</span><span class="special">(</span><span class="identifier">p</span><span class="special">.</span><span class="identifier">value</span><span class="special">);</span>
        <span class="keyword">return</span> <span class="identifier">u</span><span class="special">.</span><span class="identifier">has_value</span><span class="special">();</span>
    <span class="special">}))</span>
        <span class="keyword">return</span> <span class="identifier">urls</span><span class="special">::</span><span class="identifier">grammar</span><span class="special">::</span><span class="identifier">error</span><span class="special">::</span><span class="identifier">invalid</span><span class="special">;</span>

    <span class="comment">// all other fields are optional</span>
    <span class="comment">// magnet link is OK</span>
    <span class="keyword">return</span> <span class="identifier">m</span><span class="special">;</span>
<span class="special">}</span>

<span class="keyword">constexpr</span> <span class="identifier">magnet_link_rule_t</span> <span class="identifier">magnet_link_rule</span><span class="special">{};</span>

<span class="comment">/** Return a parsed magnet link from a string, or error.

    This is a more convenient user-facing function
    to parse magnet links.
*/</span>
<span class="identifier">boost</span><span class="special">::</span><span class="identifier">system</span><span class="special">::</span><span class="identifier">result</span><span class="special">&lt;</span> <span class="identifier">magnet_link_view</span> <span class="special">&gt;</span>
<span class="identifier">parse_magnet_link</span><span class="special">(</span> <span class="identifier">core</span><span class="special">::</span><span class="identifier">string_view</span> <span class="identifier">s</span> <span class="special">)</span> <span class="keyword">noexcept</span>
<span class="special">{</span>
    <span class="keyword">return</span> <span class="identifier">urls</span><span class="special">::</span><span class="identifier">grammar</span><span class="special">::</span><span class="identifier">parse</span><span class="special">(</span><span class="identifier">s</span><span class="special">,</span> <span class="identifier">magnet_link_rule</span><span class="special">);</span>
<span class="special">}</span>

<span class="keyword">int</span> <span class="identifier">main</span><span class="special">(</span><span class="keyword">int</span> <span class="identifier">argc</span><span class="special">,</span> <span class="keyword">char</span><span class="special">**</span> <span class="identifier">argv</span><span class="special">)</span>
<span class="special">{</span>
    <span class="comment">// This example shows how to use custom parsing</span>
    <span class="comment">// to process alternate URI schemes, in this</span>
    <span class="comment">// case "magnet"</span>
    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">argc</span> <span class="special">!=</span> <span class="number">2</span><span class="special">)</span> <span class="special">{</span>
        <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="identifier">argv</span><span class="special">[</span><span class="number">0</span><span class="special">]</span> <span class="special">&lt;&lt;</span> <span class="string">"\n"</span><span class="special">;</span>
        <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="string">"magnet &lt;link&gt;\n"</span>
                     <span class="string">"example: magnet magnet:?xt=urn:btih:d2474e86c95b19b8bcfdb92bc12c9d44667cfa36"</span>
                                            <span class="string">"&amp;dn=Leaves+of+Grass+by+Walt+Whitman.epub"</span>
                                            <span class="string">"&amp;tr=udp%3A%2F%2Ftracker.example4.com%3A80"</span>
                                            <span class="string">"&amp;tr=udp%3A%2F%2Ftracker.example5.com%3A80"</span>
                                            <span class="string">"&amp;tr=udp%3A%2F%2Ftracker.example3.com%3A6969"</span>
                                            <span class="string">"&amp;tr=udp%3A%2F%2Ftracker.example2.com%3A80"</span>
                                            <span class="string">"&amp;tr=udp%3A%2F%2Ftracker.example1.com%3A1337\n"</span><span class="special">;</span>
        <span class="keyword">return</span> <span class="identifier">EXIT_FAILURE</span><span class="special">;</span>
    <span class="special">}</span>

    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">system</span><span class="special">::</span><span class="identifier">result</span><span class="special">&lt;</span><span class="identifier">magnet_link_view</span><span class="special">&gt;</span> <span class="identifier">r</span> <span class="special">=</span>
        <span class="identifier">parse_magnet_link</span><span class="special">(</span><span class="identifier">argv</span><span class="special">[</span><span class="number">1</span><span class="special">]);</span>
    <span class="keyword">if</span> <span class="special">(!</span><span class="identifier">r</span><span class="special">)</span>
        <span class="keyword">return</span> <span class="identifier">EXIT_FAILURE</span><span class="special">;</span>

    <span class="identifier">magnet_link_view</span> <span class="identifier">m</span> <span class="special">=</span> <span class="special">*</span><span class="identifier">r</span><span class="special">;</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="string">"link: "</span> <span class="special">&lt;&lt;</span> <span class="identifier">m</span> <span class="special">&lt;&lt;</span> <span class="string">"\n"</span><span class="special">;</span>

    <span class="keyword">auto</span> <span class="identifier">xt</span> <span class="special">=</span> <span class="identifier">m</span><span class="special">.</span><span class="identifier">exact_topics</span><span class="special">();</span>
    <span class="keyword">for</span> <span class="special">(</span><span class="keyword">auto</span> <span class="identifier">h</span> <span class="special">:</span> <span class="identifier">xt</span><span class="special">)</span>
        <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="string">"topic: "</span> <span class="special">&lt;&lt;</span> <span class="identifier">h</span> <span class="special">&lt;&lt;</span> <span class="string">"\n"</span><span class="special">;</span>

    <span class="keyword">auto</span> <span class="identifier">hs</span> <span class="special">=</span> <span class="identifier">m</span><span class="special">.</span><span class="identifier">info_hashes</span><span class="special">();</span>
    <span class="keyword">for</span> <span class="special">(</span><span class="keyword">auto</span> <span class="identifier">h</span> <span class="special">:</span> <span class="identifier">hs</span><span class="special">)</span>
        <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="string">"hash: "</span> <span class="special">&lt;&lt;</span> <span class="identifier">h</span> <span class="special">&lt;&lt;</span> <span class="string">"\n"</span><span class="special">;</span>

    <span class="keyword">auto</span> <span class="identifier">ps</span> <span class="special">=</span> <span class="identifier">m</span><span class="special">.</span><span class="identifier">protocols</span><span class="special">();</span>
    <span class="keyword">for</span> <span class="special">(</span><span class="keyword">auto</span> <span class="identifier">p</span> <span class="special">:</span> <span class="identifier">ps</span><span class="special">)</span>
        <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="string">"protocol: "</span> <span class="special">&lt;&lt;</span> <span class="identifier">p</span> <span class="special">&lt;&lt;</span> <span class="string">"\n"</span><span class="special">;</span>

    <span class="keyword">auto</span> <span class="identifier">tr</span> <span class="special">=</span> <span class="identifier">m</span><span class="special">.</span><span class="identifier">address_trackers</span><span class="special">();</span>
    <span class="keyword">for</span> <span class="special">(</span><span class="keyword">auto</span> <span class="identifier">h</span> <span class="special">:</span> <span class="identifier">tr</span><span class="special">)</span>
        <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="string">"tracker: "</span> <span class="special">&lt;&lt;</span> <span class="identifier">h</span> <span class="special">&lt;&lt;</span> <span class="string">"\n"</span><span class="special">;</span>

    <span class="keyword">auto</span> <span class="identifier">xs</span> <span class="special">=</span> <span class="identifier">m</span><span class="special">.</span><span class="identifier">exact_sources</span><span class="special">();</span>
    <span class="keyword">for</span> <span class="special">(</span><span class="keyword">auto</span> <span class="identifier">x</span> <span class="special">:</span> <span class="identifier">xs</span><span class="special">)</span>
        <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="string">"exact source: "</span> <span class="special">&lt;&lt;</span> <span class="identifier">x</span> <span class="special">&lt;&lt;</span> <span class="string">"\n"</span><span class="special">;</span>

    <span class="keyword">auto</span> <span class="identifier">as</span> <span class="special">=</span> <span class="identifier">m</span><span class="special">.</span><span class="identifier">acceptable_sources</span><span class="special">();</span>
    <span class="keyword">for</span> <span class="special">(</span><span class="keyword">auto</span> <span class="identifier">a</span> <span class="special">:</span> <span class="identifier">as</span><span class="special">)</span>
        <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="string">"topic: "</span> <span class="special">&lt;&lt;</span> <span class="identifier">a</span> <span class="special">&lt;&lt;</span> <span class="string">"\n"</span><span class="special">;</span>

    <span class="keyword">auto</span> <span class="identifier">mt</span> <span class="special">=</span> <span class="identifier">m</span><span class="special">.</span><span class="identifier">manifest_topics</span><span class="special">();</span>
    <span class="keyword">for</span> <span class="special">(</span><span class="keyword">auto</span> <span class="identifier">a</span> <span class="special">:</span> <span class="identifier">mt</span><span class="special">)</span>
        <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="string">"manifest topic: "</span> <span class="special">&lt;&lt;</span> <span class="identifier">a</span> <span class="special">&lt;&lt;</span> <span class="string">"\n"</span><span class="special">;</span>

    <span class="keyword">auto</span> <span class="identifier">ws</span> <span class="special">=</span> <span class="identifier">m</span><span class="special">.</span><span class="identifier">web_seed</span><span class="special">();</span>
    <span class="keyword">for</span> <span class="special">(</span><span class="keyword">auto</span> <span class="identifier">a</span> <span class="special">:</span> <span class="identifier">ws</span><span class="special">)</span>
        <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="string">"web seed: "</span> <span class="special">&lt;&lt;</span> <span class="identifier">a</span> <span class="special">&lt;&lt;</span> <span class="string">"\n"</span><span class="special">;</span>

    <span class="keyword">auto</span> <span class="identifier">kt</span> <span class="special">=</span> <span class="identifier">m</span><span class="special">.</span><span class="identifier">keyword_topic</span><span class="special">();</span>
    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">kt</span><span class="special">)</span>
        <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="string">"keyword topic: "</span> <span class="special">&lt;&lt;</span> <span class="special">*</span><span class="identifier">kt</span> <span class="special">&lt;&lt;</span> <span class="string">"\n"</span><span class="special">;</span>

    <span class="keyword">auto</span> <span class="identifier">dn</span> <span class="special">=</span> <span class="identifier">m</span><span class="special">.</span><span class="identifier">display_name</span><span class="special">();</span>
    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">dn</span><span class="special">)</span>
        <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="string">"display name: "</span> <span class="special">&lt;&lt;</span> <span class="special">*</span><span class="identifier">dn</span> <span class="special">&lt;&lt;</span> <span class="string">"\n"</span><span class="special">;</span>

    <span class="keyword">return</span> <span class="identifier">EXIT_SUCCESS</span><span class="special">;</span>
<span class="special">}</span>
</pre>
</div>
<div class="copyright-footer">Copyright © 2021, 2022 Vinnie Falco, Alan de Freitas<p>
        Distributed under the Boost Software License, Version 1.0. (See accompanying
        file LICENSE_1_0.txt or copy at <a href="http://www.boost.org/LICENSE_1_0.txt" target="_top">http://www.boost.org/LICENSE_1_0.txt</a>)
      </p>
</div>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="mailto_urls.html"><img src="../../../../../../doc/src/images/prev.png" alt="Prev"></a><a accesskey="u" href="../examples.html"><img src="../../../../../../doc/src/images/up.png" alt="Up"></a><a accesskey="h" href="../../index.html"><img src="../../../../../../doc/src/images/home.png" alt="Home"></a><a accesskey="n" href="file_router.html"><img src="../../../../../../doc/src/images/next.png" alt="Next"></a>
</div>
</body>
</html>
