<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>mailto URLs</title>
<link rel="stylesheet" href="../../../../../../doc/src/boostbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.79.1">
<link rel="home" href="../../index.html" title="Chapter 1. Boost.URL">
<link rel="up" href="../examples.html" title="Examples">
<link rel="prev" href="finicky.html" title="Finicky">
<link rel="next" href="magnet_link.html" title="Magnet Link">
<meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<table cellpadding="2" width="100%"><tr>
<td valign="top"><img alt="Boost C++ Libraries" width="277" height="86" src="../../../../../../boost.png"></td>
<td align="center"><a href="../../../../../../index.html">Home</a></td>
<td align="center"><a href="../../../../../../libs/libraries.htm">Libraries</a></td>
<td align="center"><a href="http://www.boost.org/users/people.html">People</a></td>
<td align="center"><a href="http://www.boost.org/users/faq.html">FAQ</a></td>
<td align="center"><a href="../../../../../../more/index.htm">More</a></td>
</tr></table>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="finicky.html"><img src="../../../../../../doc/src/images/prev.png" alt="Prev"></a><a accesskey="u" href="../examples.html"><img src="../../../../../../doc/src/images/up.png" alt="Up"></a><a accesskey="h" href="../../index.html"><img src="../../../../../../doc/src/images/home.png" alt="Home"></a><a accesskey="n" href="magnet_link.html"><img src="../../../../../../doc/src/images/next.png" alt="Next"></a>
</div>
<div class="section">
<div class="titlepage"><div><div><h3 class="title">
<a name="url.examples.mailto_urls"></a><a class="link" href="mailto_urls.html" title="mailto URLs">mailto URLs</a>
</h3></div></div></div>
<p>
        <code class="computeroutput"><span class="identifier">mailto</span></code> is a URL scheme for
        email addresses. <code class="computeroutput"><span class="identifier">mailto</span></code> URL
        are used on websites to allow users to send an email to a specific address
        directly from an HTML document.
      </p>
<p>
        This example parses a mailto URL into a new view type and prints its components
        to standard output.
      </p>
<pre class="programlisting"><span class="comment">/*
    This example parses a mailto URL into a new
    view type and prints its components to
    standard output.
*/</span>

<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">url</span><span class="special">/</span><span class="identifier">grammar</span><span class="special">/</span><span class="identifier">ci_string</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">url</span><span class="special">/</span><span class="identifier">grammar</span><span class="special">/</span><span class="identifier">parse</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">url</span><span class="special">/</span><span class="identifier">optional</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">url</span><span class="special">/</span><span class="identifier">rfc</span><span class="special">/</span><span class="identifier">absolute_uri_rule</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">url</span><span class="special">/</span><span class="identifier">url</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">url</span><span class="special">/</span><span class="identifier">url_view</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">algorithm</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">iostream</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="string">"rfc.hpp"</span>

<span class="keyword">namespace</span> <span class="identifier">urls</span> <span class="special">=</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">urls</span><span class="special">;</span>

<span class="comment">// fwd-declaration for mailto_view</span>
<span class="keyword">struct</span> <span class="identifier">mailto_rule_t</span><span class="special">;</span>

<span class="comment">/// A new url type for mailto URLs</span>
<span class="comment">/**
    This class represents a URI with the mailto
    scheme.

    Unlike a urls::url_view, which only represents
    the general syntax of urls, a mailto_view
    represents a reference to fields that are
    relevant to mailto URLs, while ignoring
    elements of the general syntax
    that are not relevant to the scheme.

    This allows us to use the general syntax
    parsers to create a representation that
    is more appropriate for the specified scheme
    syntax.

    @par Specification
    @li &lt;a href="https://www.rfc-editor.org/rfc/rfc6068"
        &gt;The 'mailto' URI Scheme&lt;/a&gt;
    @li &lt;a href="https://www.rfc-editor.org/errata/rfc6068"
        &gt;RFC Errata Report&lt;/a&gt;

    @par References
    @li &lt;a href="https://en.wikipedia.org/wiki/Mailto"
        &gt;mailto (Wikipedia)&lt;/a&gt;

 */</span>
<span class="keyword">class</span> <span class="identifier">mailto_view</span>
<span class="special">{</span>
    <span class="identifier">urls</span><span class="special">::</span><span class="identifier">url_view</span> <span class="identifier">u_</span><span class="special">;</span>

<span class="keyword">public</span><span class="special">:</span>
    <span class="comment">/// Return the specified email address in the URL</span>
    <span class="comment">/**
        A mailto URL might contain multiple email
        addresses separated by commas.

        The first addresses are represented in
        the path. Other addresses are in
        any query parameter whose key is "to".

        @param i Address index

        @return The specified address
     */</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span>
    <span class="identifier">address</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">size_t</span> <span class="identifier">i</span> <span class="special">=</span> <span class="number">0</span><span class="special">)</span> <span class="keyword">const</span><span class="special">;</span>

    <span class="comment">/// @copydoc address()</span>
    <span class="identifier">urls</span><span class="special">::</span><span class="identifier">pct_string_view</span>
    <span class="identifier">encoded_address</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">size_t</span> <span class="identifier">i</span> <span class="special">=</span> <span class="number">0</span><span class="special">)</span> <span class="keyword">const</span> <span class="keyword">noexcept</span><span class="special">;</span>

    <span class="comment">/// Return number of email addresses in the URL</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">size_t</span>
    <span class="identifier">size</span><span class="special">()</span> <span class="keyword">const</span> <span class="keyword">noexcept</span><span class="special">;</span>

    <span class="comment">/// Return the specified cc email address in the URL</span>
    <span class="comment">/**
        A mailto URL might contain multiple cc
        email addresses separated by commas.

        Addresses can be represented in any query
        parameter whose key is "cc".

        @param i Address index

        @return The specified cc address
     */</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span>
    <span class="identifier">cc</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">size_t</span> <span class="identifier">i</span><span class="special">)</span> <span class="keyword">const</span><span class="special">;</span>

    <span class="comment">/// @copydoc cc()</span>
    <span class="identifier">urls</span><span class="special">::</span><span class="identifier">pct_string_view</span>
    <span class="identifier">encoded_cc</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">size_t</span> <span class="identifier">i</span><span class="special">)</span> <span class="keyword">const</span> <span class="keyword">noexcept</span><span class="special">;</span>

    <span class="comment">/// Return number of "cc" email addresses in the URL</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">size_t</span>
    <span class="identifier">size_cc</span><span class="special">()</span> <span class="keyword">const</span> <span class="keyword">noexcept</span><span class="special">;</span>

    <span class="comment">/// Return email message subject</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span>
    <span class="identifier">subject</span><span class="special">()</span> <span class="keyword">const</span><span class="special">;</span>

    <span class="comment">/// @copydoc subject()</span>
    <span class="identifier">urls</span><span class="special">::</span><span class="identifier">pct_string_view</span>
    <span class="identifier">encoded_subject</span><span class="special">()</span> <span class="keyword">const</span> <span class="keyword">noexcept</span><span class="special">;</span>

    <span class="comment">/// Return email message body</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span>
    <span class="identifier">body</span><span class="special">()</span> <span class="keyword">const</span><span class="special">;</span>

    <span class="comment">/// @copydoc body()</span>
    <span class="identifier">urls</span><span class="special">::</span><span class="identifier">pct_string_view</span>
    <span class="identifier">encoded_body</span><span class="special">()</span> <span class="keyword">const</span> <span class="keyword">noexcept</span><span class="special">;</span>

    <span class="keyword">friend</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">ostream</span><span class="special">&amp;</span>
    <span class="keyword">operator</span><span class="special">&lt;&lt;(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">ostream</span><span class="special">&amp;</span> <span class="identifier">os</span><span class="special">,</span> <span class="identifier">mailto_view</span> <span class="identifier">m</span><span class="special">)</span>
    <span class="special">{</span>
        <span class="keyword">return</span> <span class="identifier">os</span> <span class="special">&lt;&lt;</span> <span class="identifier">m</span><span class="special">.</span><span class="identifier">u_</span><span class="special">;</span>
    <span class="special">}</span>

<span class="keyword">private</span><span class="special">:</span>
    <span class="comment">// Count number of addresses in a string</span>
    <span class="keyword">static</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">size_t</span>
    <span class="identifier">addr_in_str</span><span class="special">(</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">core</span><span class="special">::</span><span class="identifier">string_view</span> <span class="identifier">s</span><span class="special">);</span>

    <span class="comment">// Get the ith address from a string</span>
    <span class="keyword">static</span>
    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">optional</span><span class="special">&lt;</span><span class="identifier">urls</span><span class="special">::</span><span class="identifier">pct_string_view</span><span class="special">&gt;</span>
    <span class="identifier">get_nth_address</span><span class="special">(</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">core</span><span class="special">::</span><span class="identifier">string_view</span> <span class="identifier">to</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">size_t</span> <span class="special">&amp;</span><span class="identifier">i</span><span class="special">)</span> <span class="keyword">noexcept</span><span class="special">;</span>

    <span class="comment">// Get param value or empty otherwise</span>
    <span class="identifier">urls</span><span class="special">::</span><span class="identifier">pct_string_view</span>
    <span class="identifier">param_or_empty</span><span class="special">(</span><span class="identifier">urls</span><span class="special">::</span><span class="identifier">pct_string_view</span> <span class="identifier">k</span><span class="special">)</span> <span class="keyword">const</span> <span class="keyword">noexcept</span><span class="special">;</span>

    <span class="keyword">friend</span> <span class="identifier">mailto_rule_t</span><span class="special">;</span>
<span class="special">};</span>

<span class="comment">/** Rule to match a mailto URL
*/</span>
<span class="keyword">struct</span> <span class="identifier">mailto_rule_t</span>
<span class="special">{</span>
    <span class="comment">/// Value type returned by the rule</span>
    <span class="keyword">using</span> <span class="identifier">value_type</span> <span class="special">=</span> <span class="identifier">mailto_view</span><span class="special">;</span>

    <span class="comment">/// Parse a sequence of characters into a mailto_view</span>
    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">system</span><span class="special">::</span><span class="identifier">result</span><span class="special">&lt;</span> <span class="identifier">value_type</span> <span class="special">&gt;</span>
    <span class="identifier">parse</span><span class="special">(</span> <span class="keyword">char</span> <span class="keyword">const</span><span class="special">*&amp;</span> <span class="identifier">it</span><span class="special">,</span> <span class="keyword">char</span> <span class="keyword">const</span><span class="special">*</span> <span class="identifier">end</span> <span class="special">)</span> <span class="keyword">const</span> <span class="keyword">noexcept</span><span class="special">;</span>
<span class="special">};</span>

<span class="keyword">constexpr</span> <span class="identifier">mailto_rule_t</span> <span class="identifier">mailto_rule</span><span class="special">{};</span>

<span class="comment">/** Return a parsed mailto URL from a string, or error.

    This is a more convenient user-facing function
    to parse mailto URLs.
*/</span>
<span class="identifier">boost</span><span class="special">::</span><span class="identifier">system</span><span class="special">::</span><span class="identifier">result</span><span class="special">&lt;</span> <span class="identifier">mailto_view</span> <span class="special">&gt;</span>
<span class="identifier">parse_mailto</span><span class="special">(</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">core</span><span class="special">::</span><span class="identifier">string_view</span> <span class="identifier">s</span> <span class="special">)</span> <span class="keyword">noexcept</span>
<span class="special">{</span>
    <span class="keyword">return</span> <span class="identifier">urls</span><span class="special">::</span><span class="identifier">grammar</span><span class="special">::</span><span class="identifier">parse</span><span class="special">(</span><span class="identifier">s</span><span class="special">,</span> <span class="identifier">mailto_rule</span><span class="special">);</span>
<span class="special">}</span>

<span class="keyword">int</span> <span class="identifier">main</span><span class="special">(</span><span class="keyword">int</span> <span class="identifier">argc</span><span class="special">,</span> <span class="keyword">char</span><span class="special">**</span> <span class="identifier">argv</span><span class="special">)</span>
<span class="special">{</span>
    <span class="comment">// This example shows how to use custom parsing</span>
    <span class="comment">// to process alternate URI schemes, in this</span>
    <span class="comment">// case "mailto"</span>
    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">argc</span> <span class="special">!=</span> <span class="number">2</span><span class="special">)</span> <span class="special">{</span>
        <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="identifier">argv</span><span class="special">[</span><span class="number">0</span><span class="special">]</span> <span class="special">&lt;&lt;</span> <span class="string">"\n"</span><span class="special">;</span>
        <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="string">"mailto &lt;URL&gt;\n"</span>
                     <span class="string">"examples:\n"</span>
                     <span class="comment">// Single e-mail address</span>
                     <span class="string">"mailto mailto:someone@example.com\n"</span>
                     <span class="comment">// Two e-mail addresses</span>
                     <span class="string">"mailto mailto:someone@example.com,someoneelse@example.com\n"</span>
                     <span class="comment">// E-mail headers</span>
                     <span class="string">"mailto mailto:someone@example.com?subject=Our%20meeting&amp;cc=someone_else@example.com&amp;body=Hi%21\n"</span>
                     <span class="comment">// E-mail headers only</span>
                     <span class="string">"mailto mailto:?to=&amp;subject=mailto%20example&amp;body=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FMailto\n"</span>
                     <span class="comment">// All fields</span>
                     <span class="string">"mailto mailto:someone@example.com,%73omeoneelse@me.com?to=thirdperson@example.com&amp;subject=Our%20meeting&amp;cc=someone_else@example.com,onemore@ex%61mple.com&amp;body=Hi%21\n"</span><span class="special">;</span>
        <span class="keyword">return</span> <span class="identifier">EXIT_FAILURE</span><span class="special">;</span>
    <span class="special">}</span>

    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">system</span><span class="special">::</span><span class="identifier">result</span><span class="special">&lt;</span><span class="identifier">mailto_view</span><span class="special">&gt;</span> <span class="identifier">r</span> <span class="special">=</span>
        <span class="identifier">parse_mailto</span><span class="special">(</span><span class="identifier">argv</span><span class="special">[</span><span class="number">1</span><span class="special">]);</span>
    <span class="keyword">if</span> <span class="special">(!</span><span class="identifier">r</span><span class="special">)</span>
        <span class="keyword">return</span> <span class="identifier">EXIT_FAILURE</span><span class="special">;</span>

    <span class="identifier">mailto_view</span> <span class="identifier">m</span> <span class="special">=</span> <span class="special">*</span><span class="identifier">r</span><span class="special">;</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="string">"link: "</span> <span class="special">&lt;&lt;</span> <span class="identifier">m</span> <span class="special">&lt;&lt;</span> <span class="string">"\n"</span><span class="special">;</span>

    <span class="keyword">for</span> <span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">size_t</span> <span class="identifier">i</span> <span class="special">=</span> <span class="number">0</span><span class="special">;</span> <span class="identifier">i</span> <span class="special">&lt;</span> <span class="identifier">m</span><span class="special">.</span><span class="identifier">size</span><span class="special">();</span> <span class="special">++</span><span class="identifier">i</span><span class="special">)</span>
        <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span>
            <span class="string">"to["</span> <span class="special">&lt;&lt;</span> <span class="identifier">i</span> <span class="special">&lt;&lt;</span> <span class="string">"]: "</span> <span class="special">&lt;&lt;</span>
            <span class="identifier">m</span><span class="special">.</span><span class="identifier">address</span><span class="special">(</span><span class="identifier">i</span><span class="special">)</span> <span class="special">&lt;&lt;</span> <span class="string">"\n"</span><span class="special">;</span>

    <span class="keyword">for</span> <span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">size_t</span> <span class="identifier">i</span> <span class="special">=</span> <span class="number">0</span><span class="special">;</span> <span class="identifier">i</span> <span class="special">&lt;</span> <span class="identifier">m</span><span class="special">.</span><span class="identifier">size_cc</span><span class="special">();</span> <span class="special">++</span><span class="identifier">i</span><span class="special">)</span>
        <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span>
            <span class="string">"cc["</span> <span class="special">&lt;&lt;</span> <span class="identifier">i</span> <span class="special">&lt;&lt;</span> <span class="string">"]: "</span> <span class="special">&lt;&lt;</span>
            <span class="identifier">m</span><span class="special">.</span><span class="identifier">address</span><span class="special">(</span><span class="identifier">i</span><span class="special">)</span> <span class="special">&lt;&lt;</span> <span class="string">"\n"</span><span class="special">;</span>

    <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="string">"subject: "</span> <span class="special">&lt;&lt;</span> <span class="identifier">m</span><span class="special">.</span><span class="identifier">subject</span><span class="special">()</span> <span class="special">&lt;&lt;</span> <span class="string">"\n"</span><span class="special">;</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="string">"body: "</span> <span class="special">&lt;&lt;</span> <span class="identifier">m</span><span class="special">.</span><span class="identifier">body</span><span class="special">()</span> <span class="special">&lt;&lt;</span> <span class="string">"\n"</span><span class="special">;</span>

    <span class="keyword">return</span> <span class="identifier">EXIT_SUCCESS</span><span class="special">;</span>
<span class="special">}</span>

<span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span>
<span class="identifier">mailto_view</span><span class="special">::</span><span class="identifier">address</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">size_t</span> <span class="identifier">i</span><span class="special">)</span> <span class="keyword">const</span>
<span class="special">{</span>
    <span class="keyword">return</span> <span class="identifier">encoded_address</span><span class="special">(</span><span class="identifier">i</span><span class="special">).</span><span class="identifier">decode</span><span class="special">();</span>
<span class="special">}</span>

<span class="identifier">urls</span><span class="special">::</span><span class="identifier">pct_string_view</span>
<span class="identifier">mailto_view</span><span class="special">::</span><span class="identifier">encoded_address</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">size_t</span> <span class="identifier">i</span><span class="special">)</span> <span class="keyword">const</span> <span class="keyword">noexcept</span>
<span class="special">{</span>
    <span class="comment">// Look for ith email address in the path string</span>
    <span class="keyword">auto</span> <span class="identifier">s</span> <span class="special">=</span> <span class="identifier">get_nth_address</span><span class="special">(</span><span class="identifier">u_</span><span class="special">.</span><span class="identifier">encoded_path</span><span class="special">(),</span> <span class="identifier">i</span><span class="special">);</span>
    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">s</span><span class="special">)</span>
        <span class="keyword">return</span> <span class="special">*</span><span class="identifier">s</span><span class="special">;</span>

    <span class="comment">// Look for ith email address in one of the "to" headers</span>
    <span class="keyword">auto</span> <span class="identifier">ps</span> <span class="special">=</span> <span class="identifier">u_</span><span class="special">.</span><span class="identifier">encoded_params</span><span class="special">();</span>
    <span class="keyword">auto</span> <span class="identifier">it</span> <span class="special">=</span> <span class="identifier">ps</span><span class="special">.</span><span class="identifier">find</span><span class="special">(</span><span class="string">"to"</span><span class="special">,</span> <span class="identifier">urls</span><span class="special">::</span><span class="identifier">ignore_case</span><span class="special">);</span>
    <span class="keyword">while</span> <span class="special">(</span><span class="identifier">it</span> <span class="special">!=</span> <span class="identifier">ps</span><span class="special">.</span><span class="identifier">end</span><span class="special">())</span>
    <span class="special">{</span>
        <span class="identifier">s</span> <span class="special">=</span> <span class="identifier">get_nth_address</span><span class="special">((*</span><span class="identifier">it</span><span class="special">++).</span><span class="identifier">value</span><span class="special">,</span> <span class="identifier">i</span><span class="special">);</span>
        <span class="keyword">if</span> <span class="special">(</span><span class="identifier">s</span><span class="special">)</span>
            <span class="keyword">return</span> <span class="special">*</span><span class="identifier">s</span><span class="special">;</span>
        <span class="identifier">it</span> <span class="special">=</span> <span class="identifier">ps</span><span class="special">.</span><span class="identifier">find</span><span class="special">(</span><span class="identifier">it</span><span class="special">,</span> <span class="string">"to"</span><span class="special">,</span> <span class="identifier">urls</span><span class="special">::</span><span class="identifier">ignore_case</span><span class="special">);</span>
    <span class="special">}</span>
    <span class="keyword">return</span> <span class="special">{};</span>
<span class="special">}</span>

<span class="identifier">std</span><span class="special">::</span><span class="identifier">size_t</span>
<span class="identifier">mailto_view</span><span class="special">::</span><span class="identifier">size</span><span class="special">()</span> <span class="keyword">const</span> <span class="keyword">noexcept</span>
<span class="special">{</span>
    <span class="comment">// Count addresses in path</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">size_t</span> <span class="identifier">n</span> <span class="special">=</span> <span class="identifier">addr_in_str</span><span class="special">(</span><span class="identifier">u_</span><span class="special">.</span><span class="identifier">encoded_path</span><span class="special">());</span>

    <span class="comment">// Count addresses in "to" headers</span>
    <span class="keyword">auto</span> <span class="identifier">ps</span> <span class="special">=</span> <span class="identifier">u_</span><span class="special">.</span><span class="identifier">encoded_params</span><span class="special">();</span>
    <span class="keyword">auto</span> <span class="identifier">it</span> <span class="special">=</span> <span class="identifier">ps</span><span class="special">.</span><span class="identifier">find</span><span class="special">(</span><span class="string">"to"</span><span class="special">,</span> <span class="identifier">urls</span><span class="special">::</span><span class="identifier">ignore_case</span><span class="special">);</span>
    <span class="keyword">while</span> <span class="special">(</span><span class="identifier">it</span> <span class="special">!=</span> <span class="identifier">ps</span><span class="special">.</span><span class="identifier">end</span><span class="special">())</span>
    <span class="special">{</span>
        <span class="identifier">n</span> <span class="special">+=</span> <span class="identifier">addr_in_str</span><span class="special">((*</span><span class="identifier">it</span><span class="special">++).</span><span class="identifier">value</span><span class="special">);</span>
        <span class="identifier">it</span> <span class="special">=</span> <span class="identifier">ps</span><span class="special">.</span><span class="identifier">find</span><span class="special">(</span><span class="identifier">it</span><span class="special">,</span> <span class="string">"to"</span><span class="special">,</span> <span class="identifier">urls</span><span class="special">::</span><span class="identifier">ignore_case</span><span class="special">);</span>
    <span class="special">}</span>
    <span class="keyword">return</span> <span class="identifier">n</span><span class="special">;</span>
<span class="special">}</span>

<span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span>
<span class="identifier">mailto_view</span><span class="special">::</span><span class="identifier">cc</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">size_t</span> <span class="identifier">i</span><span class="special">)</span> <span class="keyword">const</span>
<span class="special">{</span>
    <span class="keyword">return</span> <span class="identifier">encoded_cc</span><span class="special">(</span><span class="identifier">i</span><span class="special">).</span><span class="identifier">decode</span><span class="special">();</span>
<span class="special">}</span>

<span class="identifier">urls</span><span class="special">::</span><span class="identifier">pct_string_view</span>
<span class="identifier">mailto_view</span><span class="special">::</span><span class="identifier">encoded_cc</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">size_t</span> <span class="identifier">i</span><span class="special">)</span> <span class="keyword">const</span> <span class="keyword">noexcept</span>
<span class="special">{</span>
    <span class="comment">// Look for ith email address in one of the "to" headers</span>
    <span class="keyword">auto</span> <span class="identifier">ps</span> <span class="special">=</span> <span class="identifier">u_</span><span class="special">.</span><span class="identifier">encoded_params</span><span class="special">();</span>
    <span class="keyword">auto</span> <span class="identifier">it</span> <span class="special">=</span> <span class="identifier">ps</span><span class="special">.</span><span class="identifier">find</span><span class="special">(</span><span class="string">"cc"</span><span class="special">,</span> <span class="identifier">urls</span><span class="special">::</span><span class="identifier">ignore_case</span><span class="special">);</span>
    <span class="keyword">while</span> <span class="special">(</span><span class="identifier">it</span> <span class="special">!=</span> <span class="identifier">ps</span><span class="special">.</span><span class="identifier">end</span><span class="special">())</span>
    <span class="special">{</span>
        <span class="keyword">auto</span> <span class="identifier">s</span> <span class="special">=</span> <span class="identifier">get_nth_address</span><span class="special">((*</span><span class="identifier">it</span><span class="special">++).</span><span class="identifier">value</span><span class="special">,</span> <span class="identifier">i</span><span class="special">);</span>
        <span class="keyword">if</span> <span class="special">(</span><span class="identifier">s</span><span class="special">)</span>
            <span class="keyword">return</span> <span class="special">*</span><span class="identifier">s</span><span class="special">;</span>
        <span class="identifier">it</span> <span class="special">=</span> <span class="identifier">ps</span><span class="special">.</span><span class="identifier">find</span><span class="special">(</span><span class="identifier">it</span><span class="special">,</span> <span class="string">"cc"</span><span class="special">,</span> <span class="identifier">urls</span><span class="special">::</span><span class="identifier">ignore_case</span><span class="special">);</span>
    <span class="special">}</span>
    <span class="keyword">return</span> <span class="special">{};</span>
<span class="special">}</span>

<span class="identifier">std</span><span class="special">::</span><span class="identifier">size_t</span>
<span class="identifier">mailto_view</span><span class="special">::</span><span class="identifier">size_cc</span><span class="special">()</span> <span class="keyword">const</span> <span class="keyword">noexcept</span>
<span class="special">{</span>
    <span class="comment">// Count addresses in "to" headers</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">size_t</span> <span class="identifier">n</span> <span class="special">=</span> <span class="number">0</span><span class="special">;</span>
    <span class="keyword">auto</span> <span class="identifier">ps</span> <span class="special">=</span> <span class="identifier">u_</span><span class="special">.</span><span class="identifier">encoded_params</span><span class="special">();</span>
    <span class="keyword">auto</span> <span class="identifier">it</span> <span class="special">=</span> <span class="identifier">ps</span><span class="special">.</span><span class="identifier">find</span><span class="special">(</span><span class="string">"cc"</span><span class="special">,</span> <span class="identifier">urls</span><span class="special">::</span><span class="identifier">ignore_case</span><span class="special">);</span>
    <span class="keyword">while</span> <span class="special">(</span><span class="identifier">it</span> <span class="special">!=</span> <span class="identifier">ps</span><span class="special">.</span><span class="identifier">end</span><span class="special">())</span>
    <span class="special">{</span>
        <span class="identifier">n</span> <span class="special">+=</span> <span class="identifier">addr_in_str</span><span class="special">((*</span><span class="identifier">it</span><span class="special">++).</span><span class="identifier">value</span><span class="special">);</span>
        <span class="identifier">it</span> <span class="special">=</span> <span class="identifier">ps</span><span class="special">.</span><span class="identifier">find</span><span class="special">(</span><span class="identifier">it</span><span class="special">,</span> <span class="string">"cc"</span><span class="special">,</span> <span class="identifier">urls</span><span class="special">::</span><span class="identifier">ignore_case</span><span class="special">);</span>
    <span class="special">}</span>
    <span class="keyword">return</span> <span class="identifier">n</span><span class="special">;</span>
<span class="special">}</span>

<span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span>
<span class="identifier">mailto_view</span><span class="special">::</span><span class="identifier">subject</span><span class="special">()</span> <span class="keyword">const</span>
<span class="special">{</span>
    <span class="keyword">return</span> <span class="identifier">encoded_subject</span><span class="special">().</span><span class="identifier">decode</span><span class="special">();</span>
<span class="special">}</span>

<span class="identifier">urls</span><span class="special">::</span><span class="identifier">pct_string_view</span>
<span class="identifier">mailto_view</span><span class="special">::</span><span class="identifier">encoded_subject</span><span class="special">()</span> <span class="keyword">const</span> <span class="keyword">noexcept</span>
<span class="special">{</span>
    <span class="keyword">return</span> <span class="identifier">param_or_empty</span><span class="special">(</span><span class="string">"subject"</span><span class="special">);</span>
<span class="special">}</span>

<span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span>
<span class="identifier">mailto_view</span><span class="special">::</span><span class="identifier">mailto_view</span><span class="special">::</span><span class="identifier">body</span><span class="special">()</span> <span class="keyword">const</span>
<span class="special">{</span>
    <span class="keyword">return</span> <span class="identifier">encoded_body</span><span class="special">().</span><span class="identifier">decode</span><span class="special">();</span>
<span class="special">}</span>

<span class="identifier">urls</span><span class="special">::</span><span class="identifier">pct_string_view</span>
<span class="identifier">mailto_view</span><span class="special">::</span><span class="identifier">encoded_body</span><span class="special">()</span> <span class="keyword">const</span> <span class="keyword">noexcept</span>
<span class="special">{</span>
    <span class="keyword">return</span> <span class="identifier">param_or_empty</span><span class="special">(</span><span class="string">"body"</span><span class="special">);</span>
<span class="special">}</span>

<span class="identifier">std</span><span class="special">::</span><span class="identifier">size_t</span>
<span class="identifier">mailto_view</span><span class="special">::</span><span class="identifier">addr_in_str</span><span class="special">(</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">core</span><span class="special">::</span><span class="identifier">string_view</span> <span class="identifier">s</span><span class="special">)</span>
<span class="special">{</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">size_t</span> <span class="identifier">n</span> <span class="special">=</span> <span class="number">0</span><span class="special">;</span>
    <span class="keyword">bool</span> <span class="identifier">empty</span> <span class="special">=</span> <span class="keyword">true</span><span class="special">;</span>
    <span class="keyword">for</span> <span class="special">(</span><span class="keyword">char</span> <span class="identifier">c</span> <span class="special">:</span> <span class="identifier">s</span><span class="special">)</span>
    <span class="special">{</span>
        <span class="keyword">if</span> <span class="special">(</span><span class="identifier">c</span> <span class="special">==</span> <span class="char">','</span><span class="special">)</span>
        <span class="special">{</span>
            <span class="identifier">n</span> <span class="special">+=</span> <span class="special">!</span><span class="identifier">empty</span><span class="special">;</span>
            <span class="identifier">empty</span> <span class="special">=</span> <span class="keyword">true</span><span class="special">;</span>
        <span class="special">}</span>
        <span class="keyword">else</span>
        <span class="special">{</span>
            <span class="identifier">empty</span> <span class="special">=</span> <span class="keyword">false</span><span class="special">;</span>
        <span class="special">}</span>
    <span class="special">}</span>
    <span class="identifier">n</span> <span class="special">+=</span> <span class="special">!</span><span class="identifier">empty</span><span class="special">;</span>
    <span class="keyword">return</span> <span class="identifier">n</span><span class="special">;</span>
<span class="special">}</span>

<span class="identifier">boost</span><span class="special">::</span><span class="identifier">optional</span><span class="special">&lt;</span><span class="identifier">urls</span><span class="special">::</span><span class="identifier">pct_string_view</span><span class="special">&gt;</span>
<span class="identifier">mailto_view</span><span class="special">::</span><span class="identifier">get_nth_address</span><span class="special">(</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">core</span><span class="special">::</span><span class="identifier">string_view</span> <span class="identifier">to</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">size_t</span> <span class="special">&amp;</span><span class="identifier">i</span><span class="special">)</span> <span class="keyword">noexcept</span>
<span class="special">{</span>
    <span class="keyword">auto</span> <span class="identifier">p</span> <span class="special">=</span> <span class="identifier">to</span><span class="special">.</span><span class="identifier">find</span><span class="special">(</span><span class="char">','</span><span class="special">);</span>
    <span class="keyword">while</span> <span class="special">(</span><span class="identifier">p</span> <span class="special">!=</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">core</span><span class="special">::</span><span class="identifier">string_view</span><span class="special">::</span><span class="identifier">npos</span><span class="special">)</span>
    <span class="special">{</span>
        <span class="keyword">if</span> <span class="special">(</span><span class="identifier">i</span> <span class="special">==</span> <span class="number">0</span><span class="special">)</span>
            <span class="keyword">return</span> <span class="identifier">urls</span><span class="special">::</span><span class="identifier">pct_string_view</span><span class="special">(</span>
                <span class="identifier">to</span><span class="special">.</span><span class="identifier">substr</span><span class="special">(</span><span class="number">0</span><span class="special">,</span> <span class="identifier">p</span><span class="special">));</span>
        <span class="special">--</span><span class="identifier">i</span><span class="special">;</span>
        <span class="identifier">to</span><span class="special">.</span><span class="identifier">remove_prefix</span><span class="special">(</span><span class="identifier">p</span> <span class="special">+</span> <span class="number">1</span><span class="special">);</span>
        <span class="identifier">p</span> <span class="special">=</span> <span class="identifier">to</span><span class="special">.</span><span class="identifier">find</span><span class="special">(</span><span class="char">','</span><span class="special">);</span>
    <span class="special">}</span>
    <span class="keyword">if</span> <span class="special">(!</span><span class="identifier">to</span><span class="special">.</span><span class="identifier">empty</span><span class="special">())</span>
    <span class="special">{</span>
        <span class="keyword">if</span> <span class="special">(</span><span class="identifier">i</span> <span class="special">==</span> <span class="number">0</span><span class="special">)</span>
            <span class="keyword">return</span> <span class="identifier">urls</span><span class="special">::</span><span class="identifier">pct_string_view</span><span class="special">(</span>
                <span class="identifier">to</span><span class="special">.</span><span class="identifier">substr</span><span class="special">(</span><span class="number">0</span><span class="special">,</span> <span class="identifier">p</span><span class="special">));</span>
        <span class="special">--</span><span class="identifier">i</span><span class="special">;</span>
    <span class="special">}</span>
    <span class="keyword">return</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">none</span><span class="special">;</span>
<span class="special">}</span>

<span class="identifier">urls</span><span class="special">::</span><span class="identifier">pct_string_view</span>
<span class="identifier">mailto_view</span><span class="special">::</span><span class="identifier">param_or_empty</span><span class="special">(</span><span class="identifier">urls</span><span class="special">::</span><span class="identifier">pct_string_view</span> <span class="identifier">k</span><span class="special">)</span> <span class="keyword">const</span> <span class="keyword">noexcept</span>
<span class="special">{</span>
    <span class="keyword">auto</span> <span class="identifier">ps</span> <span class="special">=</span> <span class="identifier">u_</span><span class="special">.</span><span class="identifier">encoded_params</span><span class="special">();</span>
    <span class="keyword">auto</span> <span class="identifier">it</span> <span class="special">=</span> <span class="identifier">ps</span><span class="special">.</span><span class="identifier">find</span><span class="special">(</span><span class="identifier">k</span><span class="special">,</span> <span class="identifier">urls</span><span class="special">::</span><span class="identifier">ignore_case</span><span class="special">);</span>
    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">it</span> <span class="special">!=</span> <span class="identifier">ps</span><span class="special">.</span><span class="identifier">end</span><span class="special">())</span>
        <span class="keyword">return</span> <span class="special">(*</span><span class="identifier">it</span><span class="special">).</span><span class="identifier">value</span><span class="special">;</span>
    <span class="keyword">return</span> <span class="special">{};</span>
<span class="special">}</span>

<span class="keyword">auto</span>
<span class="identifier">mailto_rule_t</span><span class="special">::</span><span class="identifier">parse</span><span class="special">(</span> <span class="keyword">char</span> <span class="keyword">const</span><span class="special">*&amp;</span> <span class="identifier">it</span><span class="special">,</span> <span class="keyword">char</span> <span class="keyword">const</span><span class="special">*</span> <span class="identifier">end</span> <span class="special">)</span> <span class="keyword">const</span> <span class="keyword">noexcept</span>
    <span class="special">-&gt;</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">system</span><span class="special">::</span><span class="identifier">result</span><span class="special">&lt;</span> <span class="identifier">value_type</span> <span class="special">&gt;</span>
<span class="special">{</span>
    <span class="comment">// Syntax-based rules</span>
    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">system</span><span class="special">::</span><span class="identifier">result</span><span class="special">&lt;</span><span class="identifier">urls</span><span class="special">::</span><span class="identifier">url_view</span><span class="special">&gt;</span> <span class="identifier">r</span> <span class="special">=</span>
        <span class="identifier">urls</span><span class="special">::</span><span class="identifier">grammar</span><span class="special">::</span><span class="identifier">parse</span><span class="special">(</span><span class="identifier">it</span><span class="special">,</span> <span class="identifier">end</span><span class="special">,</span> <span class="identifier">urls</span><span class="special">::</span><span class="identifier">absolute_uri_rule</span><span class="special">);</span>
    <span class="keyword">if</span> <span class="special">(!</span><span class="identifier">r</span><span class="special">)</span>
        <span class="keyword">return</span> <span class="identifier">r</span><span class="special">.</span><span class="identifier">error</span><span class="special">();</span>

    <span class="comment">// Scheme-based rules</span>
    <span class="identifier">mailto_view</span> <span class="identifier">m</span><span class="special">;</span>
    <span class="identifier">m</span><span class="special">.</span><span class="identifier">u_</span> <span class="special">=</span> <span class="special">*</span><span class="identifier">r</span><span class="special">;</span>
    <span class="keyword">auto</span> <span class="identifier">valid_header</span> <span class="special">=</span> <span class="special">[](</span><span class="identifier">urls</span><span class="special">::</span><span class="identifier">param_pct_view</span> <span class="identifier">p</span><span class="special">)</span> <span class="special">{</span>
        <span class="keyword">return</span>
            <span class="identifier">urls</span><span class="special">::</span><span class="identifier">grammar</span><span class="special">::</span><span class="identifier">parse</span><span class="special">(</span><span class="identifier">p</span><span class="special">.</span><span class="identifier">key</span><span class="special">,</span> <span class="identifier">hfname_rule</span><span class="special">)</span> <span class="special">&amp;&amp;</span>
            <span class="identifier">urls</span><span class="special">::</span><span class="identifier">grammar</span><span class="special">::</span><span class="identifier">parse</span><span class="special">(</span><span class="identifier">p</span><span class="special">.</span><span class="identifier">value</span><span class="special">,</span> <span class="identifier">hfvalue_rule</span><span class="special">)</span> <span class="special">&amp;&amp;</span>
            <span class="identifier">p</span><span class="special">.</span><span class="identifier">has_value</span> <span class="special">&amp;&amp;</span>
            <span class="special">(!</span><span class="identifier">urls</span><span class="special">::</span><span class="identifier">grammar</span><span class="special">::</span><span class="identifier">ci_is_equal</span><span class="special">(</span><span class="identifier">p</span><span class="special">.</span><span class="identifier">key</span><span class="special">,</span> <span class="string">"to"</span><span class="special">)</span> <span class="special">||</span>
             <span class="identifier">urls</span><span class="special">::</span><span class="identifier">grammar</span><span class="special">::</span><span class="identifier">parse</span><span class="special">(</span><span class="identifier">p</span><span class="special">.</span><span class="identifier">value</span><span class="special">,</span> <span class="identifier">addr_spec_rule</span><span class="special">));</span>
    <span class="special">};</span>
    <span class="keyword">auto</span> <span class="identifier">ps</span> <span class="special">=</span> <span class="identifier">m</span><span class="special">.</span><span class="identifier">u_</span><span class="special">.</span><span class="identifier">encoded_params</span><span class="special">();</span>
    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">m</span><span class="special">.</span><span class="identifier">u_</span><span class="special">.</span><span class="identifier">scheme</span><span class="special">()</span> <span class="special">==</span> <span class="string">"mailto"</span> <span class="special">&amp;&amp;</span>
        <span class="special">!</span><span class="identifier">m</span><span class="special">.</span><span class="identifier">u_</span><span class="special">.</span><span class="identifier">has_authority</span><span class="special">()</span> <span class="special">&amp;&amp;</span>
        <span class="identifier">urls</span><span class="special">::</span><span class="identifier">grammar</span><span class="special">::</span><span class="identifier">parse</span><span class="special">(</span><span class="identifier">m</span><span class="special">.</span><span class="identifier">u_</span><span class="special">.</span><span class="identifier">encoded_path</span><span class="special">(),</span> <span class="identifier">to_rule</span><span class="special">)</span> <span class="special">&amp;&amp;</span>
        <span class="identifier">std</span><span class="special">::</span><span class="identifier">all_of</span><span class="special">(</span><span class="identifier">ps</span><span class="special">.</span><span class="identifier">begin</span><span class="special">(),</span> <span class="identifier">ps</span><span class="special">.</span><span class="identifier">end</span><span class="special">(),</span> <span class="identifier">valid_header</span><span class="special">))</span>
        <span class="keyword">return</span> <span class="identifier">m</span><span class="special">;</span>
    <span class="keyword">return</span> <span class="identifier">urls</span><span class="special">::</span><span class="identifier">grammar</span><span class="special">::</span><span class="identifier">error</span><span class="special">::</span><span class="identifier">invalid</span><span class="special">;</span>
<span class="special">}</span>
</pre>
</div>
<div class="copyright-footer">Copyright © 2021, 2022 Vinnie Falco, Alan de Freitas<p>
        Distributed under the Boost Software License, Version 1.0. (See accompanying
        file LICENSE_1_0.txt or copy at <a href="http://www.boost.org/LICENSE_1_0.txt" target="_top">http://www.boost.org/LICENSE_1_0.txt</a>)
      </p>
</div>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="finicky.html"><img src="../../../../../../doc/src/images/prev.png" alt="Prev"></a><a accesskey="u" href="../examples.html"><img src="../../../../../../doc/src/images/up.png" alt="Up"></a><a accesskey="h" href="../../index.html"><img src="../../../../../../doc/src/images/home.png" alt="Home"></a><a accesskey="n" href="magnet_link.html"><img src="../../../../../../doc/src/images/next.png" alt="Next"></a>
</div>
</body>
</html>
