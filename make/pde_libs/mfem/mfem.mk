######################################################################
#
# Use the config.mk generated by mfem configure
# process, unstally located at
# 
# $(MFEM_INSTALL_DIR)/share/mfem/config.mk
# 
# Though this is build dependent, the mfem in
# Stan must be configured with parallel linear solver(petsc or hypre),
# as this is tested in unit tests.
# 
######################################################################

ifndef MFEM_INSTALL_DIR
$(error MFEM_INSTALL_DIR is not set)
endif

# define macro for prepropcessing
CPPFLAGS += -DSTAN_MFEM

# include the library options determined by configure
include $(MFEM_INSTALL_DIR)/share/mfem/config.mk
MFEM_USE_EXCEPTIONS  = YES

#
# source files
MFEM_PROJ_SRC 	:= $(wildcard $(MFEM_PROJ_PATH)/mfem_*.cpp)

#
# object files
MFEM_PROJ_OBJ		:= $(patsubst %.cpp, %.o, $(MFEM_PROJ_SRC))

$(MFEM_PROJ_PATH)/stan_mfem_proj: $(MFEM_PROJ_OBJ)
	$(LINK.cpp) -o $@ $^
$(MFEM_PROJ_PATH)/stan_mfem_test: $(MFEM_PROJ_OBJ) $(GTEST_MAIN) $(GTEST)/src/gtest-all.o
	$(LINK.cpp) -o $@ $^


###############################################################################

.PHONY: mfem-dust mfem-clean

###############################################################################
# amend flags with those from mfem
#

CC = $(MFEM_CXX)
CPPFLAGS += $(MFEM_CPPFLAGS)
CXXFLAGS += $(MFEM_CXXFLAGS)
CXXFLAGS += $(MFEM_INCFLAGS)
# CXXFLAGS :=$(filter-out -std=gnu++11,$(CXXFLAGS))
# CXXFLAGS :=$(filter-out -Wunused,$(CXXFLAGS))
# CXXFLAGS :=$(filter-out -Wunused-parameter,$(CXXFLAGS))
# CXXFLAGS :=$(filter-out -Qunused-arguments,$(CXXFLAGS))
# CXXFLAGS +=-DMFEM_HAVE_CXX14_MAKE_UNIQUE

LDFLAGS += $(MFEM_LIBS) $(MFEM_EXT_LIBS)

# Useful rules.
mfem-dust:
	@echo "Deleting old output and runtime files"
	@rm -f *.mesh out*.m job_output.txt output.txt* *.gmv.* *.plt.* out*.xdr* out*.xda* PI* mfem-complete

mfem-clean:
	@rm -rf *.o .libs .depend

mfem-echo:
	@echo MFEM_PROJ_SRC = $(MFEM_PROJ_SRC)
	@echo MFEM_PROJ_OBJ = $(MFEM_PROJ_OBJ)

mfem-complete: $(wildcard *.in)
#	@$(MAKE) dust
	@$(MAKE) -C $(dir $(target)) $(notdir $(target))
	@echo "***************************************************************"
	@echo "* Running App " $(notdir $(target))
	@echo "***************************************************************"
	@echo " "
	${MFEM_RUN} $(target) ${MFEM_OPTIONS} 2>&1 | tee output.txt
	@bzip2 -f output.txt
	@echo " "
	@echo "***************************************************************"
	@echo "* Done Running App " $(notdir $(target))
	@echo "***************************************************************"

