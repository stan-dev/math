<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.7"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Stan Math Library: MPI</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js", "TeX/AMSmath.js", "TeX/AMSsymbols.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="standoxy.css" rel="stylesheet" type="text/css">
<!--  -->
<script type="text/javascript" src="eigen_navtree_hacks.js"></script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="stanlogo-main.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname"><a href="https://mc-stan.org/math">Stan Math Library</a>
   &#160;<span id="projectnumber">5.0.0</span>
   </div>
   <div id="projectbrief">Automatic Differentiation</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.7 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_doxygen_2parallelism__support_2mpi__parallelism.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">MPI</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The <a href="https://en.wikipedia.org/wiki/Message_Passing_Interface">message passing interface (MPI)</a> allows the exchange of messages between different processes. We can use MPI to parallelize the computation of a single log probability computation by using multiple processes. Since each process is <em>independent</em> of all other processes, we can run automatic differentiation (AD) in parallel by providing each process its own AD stack, then combining in a synchronized step which fits into the Math library's AD design.</p>
<p>The target audience for MPI are those with large computer clusters. For users looking for parallel computation on a single computer, please turn to a [[threading based approach|Threading Support]], which is easier to use and provides similar performance gains.</p>
<h1><a class="anchor" id="mpi-requirements"></a>
Requirements</h1>
<p>A base MPI installation must be installed on the system. See the <a href="http://www.boost.org/doc/libs/1_66_0/doc/html/mpi/getting_started.html#mpi.mpi_impl">instructions from <code>boost.mpi</code></a> to verify that there is a working MPI system.</p>
<p>Stan supports MPI on Mac OS X and Linux. <b>Windows is not supported at the moment.</b></p>
<p>For Mac OS X and Linux, any MPI installation that works with <code>boost.mpi</code> is supported. The two major open-source base MPI implementations are <code>mpich</code> and <code>openMPI</code>. The Math library is tested with these two implementations while others supported by <code>boost.mpi</code> may work as well.</p>
<p>The base MPI installation provides the command line tools</p><ul>
<li><code>mpicxx</code>: The recommended compiler command to use when building any MPI application.</li>
<li><code>mpirun</code>: Wrapper binary used to start a MPI enabled binary on a given machine.</li>
</ul>
<h2><a class="anchor" id="autotoc_md115"></a>
Installation on a cluster system</h2>
<p>Please ask your system administrator for details on how to compile, execute, and submit MPI applications.</p>
<h2><a class="anchor" id="autotoc_md116"></a>
Installation on Mac OS X</h2>
<p>Install <code>mpich</code> from MacPorts or homebrew.</p>
<h2><a class="anchor" id="autotoc_md117"></a>
Installation on Linux</h2>
<p>The package distribution system on your version of linux should have pre-built <code>mpich</code> (or <code>openmpi</code>) available.</p>
<p>In addition to that, you must have the following packages installed (Ubuntu package names listed): <code>python-dev, libxml2-dev, libxlst-dev</code>, and you may be required to add the following to your <code>make/local</code>: <code>LDLIBS+=-lpthread</code>.</p>
<h2><a class="anchor" id="autotoc_md118"></a>
Installation on Windows</h2>
<p>MPI is not supported on Windows at this time.</p>
<h2><a class="anchor" id="autotoc_md119"></a>
Note on Boost</h2>
<p>Stan builds it's own <code>boost.mpi</code> and <code>boost.serialization</code> libraries and installs these into its library subfolder. If the operating system provides these Boost libraries and it's required to use them, there is additional configuration that needs to be done (through <code>make/local</code>) to use that installation.</p>
<p>Moreover, the boost libraries are build using the boost build system. Boost build will attempt to auto-detect the MPI installation specifics on your system and the toolset to use. Should boost's auto-detect fail or a specific configuration be required, then users can configure the boost build system through the configuration file <code>stan-math/lib/boost_1.xx.x/user_config.jam</code> manually as needed.</p>
<h2><a class="anchor" id="autotoc_md120"></a>
Note on compilers used</h2>
<p>We strongly recommend to use the <code>mpicxx</code> command to build any program using MPI within Math. While it is possible to change the compiler used with these commands (openMPI has a <code>-cxx=</code> option, for example), this can only be done with great caution. The complication is that during compilation of the base MPI libraries the exact bit representation of each type is analyzed and strong deviations due to compiler changes may lead to unexpected behavior. In case of compiler mismatch between the base MPI libraries and <code>boost.mpi</code> (and Math) changes in the compiler ABI can lead to unexpected segfaults. Therefore, we recommend to use the <code>mpicxx</code> as compiler and do not recommend to deviate from the compiler used to build MPI. Often this means to use the system default compiler which may be rather old and not ideal for Stan. In such cases a more modern gcc (if gcc is the system compiler) can be considered as long as no ABI changes are known.</p>
<h1><a class="anchor" id="autotoc_md121"></a>
Setting up the Math library with MPI</h1>
<p>Stan uses the <code>boost.mpi</code> library to interface with the installed MPI implementation. <code>boost.mpi</code> is built automatically by the Math library when the Math library is configured for MPI. To configure MPI for the Math library, please proceed ass follows:</p>
<p>0. Ensure that a base MPI installation is available and accessible on the system. See <a class="el" href="md_doxygen_2parallelism__support_2mpi__parallelism.html#mpi-requirements">Requirements</a>.</p><ol type="1">
<li>Open a text file called <code>make/local</code>; if it does not exist, create one.</li>
<li>Add these lines to the <code>make/local</code> file: <div class="fragment"><div class="line">STAN_MPI=true</div>
<div class="line">CXX=mpicxx</div>
</div><!-- fragment --></li>
<li>Optional: instead of using <code>CXX=mpicxx</code>, the user can specify the compiler with the proper compiler and linker options needed to build an MPI enabled binary (the command <code>mpicxx -show</code> displays for <code>mpich</code> what is executed / <code>openmpi</code> uses <code>mpicxx -show-me</code>), but please read the note on compilers above.</li>
<li>Clean all binaries. After changing configuration through <code>make/local</code>, all the tests should be rebuilt. Please type: <div class="fragment"><div class="line">make clean-all</div>
</div><!-- fragment --></li>
</ol>
<p>Once the Math library is configured for MPI, the tests will be built with MPI. Note that the <code>boost.mpi</code> and <code>boost.serialization</code> library are build and linked against dynamically.</p>
<h1><a class="anchor" id="autotoc_md122"></a>
Running tests with MPI</h1>
<p>Once MPI is enabled, the <code>runTests.py</code> script in the <code>cmdstan/stan/lib/stan_math</code> directory will run all tests in an environment which resembles a MPI run. There are two types of tests:</p>
<ul>
<li>conventional tests: This includes all unit tests which do not use any MPI parallelism. In order to run these tests in a MPI like way we compile these with the <code>mpicxx</code> command and execute them with the <code>mpirun</code> run command. However, we explicitly disable for these serial tests the use of multiple processes. That is, the <code>runTests.py</code> script executes the tests with <code>mpirun -np 1 test/unit/.../.../some_test</code>. Starting up multiple threads for serial only tests would lead to race conditions since these codes are not prepared for parallelism.</li>
<li>dedicated MPI tests: All tests matching the regular expression <code>*mpi_*test.cpp</code> will be executed by <code>runTests.py</code> with `mpirun -np #CPU test/unit/.../.../some_mpi_test.cpp` and `#CPU` will be set to the same argument as given to the <code>-j</code> option of <code>runTests.py</code>, but it will use at least 2 processes. This is to ensure that the MPI tests are actually run with multiple processes in parallel to emulate behavior under MPI execution. Note that <code>mpirun</code> is usually configured to disallow #CPU to exceed the number of physical CPUs found on the machine.</li>
</ul>
<p>To illustrate what is happening let's consider two examples (assuming MPI is enabled as described above):</p>
<ul>
<li>conventional test: <div class="fragment"><div class="line">./runTests.py test/unit/math/prim/functor/map_rect_test.cpp</div>
<div class="line"># =&gt; compilation with mpicxx</div>
<div class="line"># =&gt; execution with mpirun using a single process</div>
<div class="line"># mpirun -np 1 test/unit/math/prim/functor/map_rect_test</div>
</div><!-- fragment --></li>
<li>dedicated MPI test: <div class="fragment"><div class="line">./runTests.py test/unit/math/prim/functor/mpi_cluster_test.cpp</div>
<div class="line"># =&gt; compilation with mpicxx</div>
<div class="line"># =&gt; execution with mpirun using at least two processes</div>
<div class="line"># mpirun -np 2 test/unit/math/prim/functor/mpi_cluster_test</div>
<div class="line"> </div>
<div class="line">./runTests.py -j8 test/unit/math/prim/functor/mpi_cluster_test.cpp</div>
<div class="line"># =&gt; compilation with mpicxx</div>
<div class="line"># =&gt; execution with mpirun using 8 processes</div>
<div class="line"># mpirun -np 8 test/unit/math/prim/functor/mpi_cluster_test</div>
</div><!-- fragment --> </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->

<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">
    <div class="contents" style="font-size:100%;">
      <span style="float:left; margin=0 1em 0 1em;">
      &nbsp;&nbsp;&nbsp;&nbsp;
      [ <a href="http://mc-stan.org/">Stan Home Page</a> ]
      </span>
      <span style="float:right; margin=0 1em 0 1em;">
      <i>&copy; 2011&ndash;2019,
      Stan Development Team.
      &nbsp;&nbsp;&nbsp;&nbsp;
      </i>
      </span>
    </div> </li>
  </ul>
</div>
</body>
</html>
