<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.7"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Stan Math Library: OpenCL CPU/GPU Support</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js", "TeX/AMSmath.js", "TeX/AMSsymbols.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="standoxy.css" rel="stylesheet" type="text/css">
<!--  -->
<script type="text/javascript" src="eigen_navtree_hacks.js"></script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="stanlogo-main.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname"><a href="https://mc-stan.org/math">Stan Math Library</a>
   &#160;<span id="projectnumber">5.0.0</span>
   </div>
   <div id="projectbrief">Automatic Differentiation</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.7 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_doxygen_2parallelism__support_2opencl__support.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">OpenCL CPU/GPU Support</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a href="https://www.khronos.org/opencl/">OpenCL</a> is an open-source framework for writing programs that utilize a platform with heterogeneous hardware. Stan uses OpenCL to design the GPU routines for the Cholesky Decomposition and it's derivative. Other routines will be available in the future. These routines are suitable for programs which require solving large <code>NxM</code> matrices (<code>N&gt;600</code>) such as algorithms that utilize large covariance matrices.</p>
<h1><a class="anchor" id="autotoc_md123"></a>
Requirements</h1>
<p>Users must have suitable hardware (e.g. Nvidia or AMD gpu), valid OpenCL driver, SDK and a suitable C/C++ compiler installed on their computer.</p>
<h1><a class="anchor" id="autotoc_md124"></a>
Installation</h1>
<h2><a class="anchor" id="autotoc_md125"></a>
Linux</h2>
<p>The following guide is for Ubuntu, but it should be similar for any other Linux distribution. You should have the GNU compiler suite or clang compiler installed beforehand.</p>
<p>Install the Nvidia CUDA toolkit and clinfo tool if you have an Nvidia GPU </p><div class="fragment"><div class="line">apt update</div>
<div class="line">apt install nvidia-cuda-toolkit clinfo</div>
</div><!-- fragment --><p>Those with AMD devices can install the OpenCL driver available through</p>
<div class="fragment"><div class="line">apt install -y libclc-amdgcn mesa-opencl-icd clinfo</div>
</div><!-- fragment --><p>If your device is not supported by the current drivers available you can try Paulo Miguel <a href="https://laanwj.github.io/2016/05/06/opencl-ubuntu1604.html">PPA</a></p>
<div class="fragment"><div class="line">add-apt-repository ppa:paulo-miguel-dias/mesa</div>
<div class="line">apt-get update</div>
<div class="line">apt-get install libclc-amdgcn mesa-opencl-icd</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md126"></a>
MacOS</h2>
<p>Mac's should already have the OpenCL driver installed if you have the appropriate hardware.</p>
<p>Note that if you are building on a mac laptop you may not have a GPU device. You can still use the OpenCL routines for parallelization on your CPU.</p>
<h2><a class="anchor" id="autotoc_md127"></a>
Windows</h2>
<p>Install the latest <a href="https://cran.r-project.org/bin/windows/Rtools/">Rtools</a> suite if you don't already have it. During the installation make sure that the 64 bit toolchain is installed. You also need to verify that you have the System Enviroment variable <code>Path</code> updated to include the path to the g++ compiler (<code>&lt;Rtools installation path&gt;\mingw_64\bin</code>).</p>
<p>If you have a Nvidia card, install the latest <a href="https://developer.nvidia.com/cuda-toolkit">Nvidia CUDA toolkit</a>. AMD users should use <a href="http://amd-dev.wpengine.netdna-cdn.com/app-sdk/installers/APPSDKInstaller/3.0.130.135-GA/full/AMD-APP-SDKInstaller-v3.0.130.135-GA-windows-F-x64.exe">AMD APP SDK</a>.</p>
<p>Users can check that their installation is valid by downloading and running clinfo. <br  />
</p><ul>
<li><a href="https://ci.appveyor.com/api/projects/oblomov/clinfo/artifacts/clinfo.exe?job=platform%3a+x64">download clinfo.exe</a></li>
</ul>
<h2><a class="anchor" id="autotoc_md128"></a>
Setting up the Math Library to run on a GPU</h2>
<p>To turn on GPU computation:</p>
<ol type="1">
<li>Check and record what device and platform you would like to use with <a href="https://github.com/Oblomov/clinfo">clinfo</a>; you will the platform and device index such as the printout below</li>
</ol>
<div class="fragment"><div class="line">clinfo -l</div>
<div class="line"># Platform #0: Clover</div>
<div class="line"># Platform #1: Portable Computing Language</div>
<div class="line">#  `-- Device #0: pthread-AMD Ryzen Threadripper 2950X 16-Core Processor</div>
<div class="line"># Platform #2: NVIDIA CUDA</div>
<div class="line">#  +-- Device #0: TITAN Xp</div>
<div class="line">#  `-- Device #1: GeForce GTX 1080 Ti</div>
</div><!-- fragment --><ol type="1">
<li>In the top level of the math library, open a text file called make/local. if it does not exist, create one.</li>
<li>Add these lines to the make/local file:</li>
</ol>
<div class="fragment"><div class="line">STAN_OPENCL=true</div>
<div class="line">OPENCL_DEVICE_ID=${CHOSEN_INDEX}</div>
<div class="line">OPENCL_PLATFORM_ID=${CHOSEN_INDEX}</div>
</div><!-- fragment --><p>where the user will replace ${CHOSEN_INDEX} with the index of the device and platform they would like to use. In most cases these two will be 0. If you are using Windows append the following lines at the end of the make/local file in order to link with the appropriate OpenCL library:</p>
<ul>
<li>Nvidia <div class="fragment"><div class="line">CC = g++</div>
<div class="line">LDFLAGS_OPENCL= -L&quot;$(CUDA_PATH)\lib\x64&quot; -lOpenCL</div>
</div><!-- fragment --></li>
<li>AMD <div class="fragment"><div class="line">CC = g++</div>
<div class="line">LDFLAGS_OPENCL= -L&quot;$(AMDAPPSDKROOT)lib\x86_64&quot; -lOpenCL</div>
</div><!-- fragment --></li>
</ul>
<h2><a class="anchor" id="autotoc_md129"></a>
Running Tests with OpenCL</h2>
<p>Once you have done the above step, <code>runTests.py</code> should execute with the GPU enabled. All tests will match the phrase <code>*_opencl_*</code> and tests can be filtered such as</p>
<div class="fragment"><div class="line">./runTests.py test/unit -f opencl</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md130"></a>
Using the OpenCL backend</h2>
<p>The OpenCL backend can be used for reverse mode AD as well as primitive functions on containers of basic C++ scalar types. Below is the list of functions and distributions that are currently supported.</p>
<h3><a class="anchor" id="autotoc_md131"></a>
Reverse mode</h3>
<p>An example of using OpenCL supported Stan Math functions for reverse mode AD is shown below:</p>
<div class="fragment"><div class="line"><span class="keyword">using </span><a class="code hl_namespace" href="namespacestan_1_1math.html">stan::math</a>;</div>
<div class="line"> </div>
<div class="line">Eigen::Matrix&lt;double, -1, -1&gt; A = Eigen::Matrix&lt;double, -1, -1&gt;::Random(N, M);</div>
<div class="line">Eigen::Matrix&lt;double, -1, -1&gt; B = Eigen::Matrix&lt;double, -1, -1&gt;::Random(M, N);</div>
<div class="line"><a class="code hl_class" href="classstan_1_1math_1_1var__value.html">var_value&lt;matrix_cl&lt;double&gt;</a>&gt; A_cl = to_matrix_cl(A);</div>
<div class="line"><a class="code hl_class" href="classstan_1_1math_1_1var__value.html">var_value&lt;matrix_cl&lt;double&gt;</a>&gt; B_cl = to_matrix_cl(B);</div>
<div class="line"><a class="code hl_class" href="classstan_1_1math_1_1var__value.html">var_value&lt;matrix_cl&lt;double&gt;</a>&gt; C_cl = A_cl * B_cl;</div>
<div class="line"><a class="code hl_class" href="classstan_1_1math_1_1var__value.html">var</a> C_sum = sum(C_cl);</div>
<div class="line">C_sum.grad();</div>
<div class="ttc" id="aclassstan_1_1math_1_1var__value_html"><div class="ttname"><a href="classstan_1_1math_1_1var__value.html">stan::math::var_value</a></div><div class="ttdef"><b>Definition</b> <a href="var__value__fwd__declare_8hpp_source.html#l00008">var_value_fwd_declare.hpp:8</a></div></div>
<div class="ttc" id="anamespacestan_1_1math_html"><div class="ttname"><a href="namespacestan_1_1math.html">stan::math</a></div><div class="ttdoc">Matrices and templated mathematical functions.</div><div class="ttdef"><b>Definition</b> <a href="fwd_2constraint_2unit__vector__constrain_8hpp_source.html#l00016">unit_vector_constrain.hpp:16</a></div></div>
</div><!-- fragment --><h4><a class="anchor" id="autotoc_md132"></a>
Supported functions</h4>
<ul>
<li>acos, acosh</li>
<li>add, operator+</li>
<li>add_diag, diag_matrix, diagonal</li>
<li>asin, asinh</li>
<li>atan, atanh</li>
<li>beta, lbeta</li>
<li>block, col, row, sub_col, sub_row</li>
<li>cbrt</li>
<li>ceil, floor, round, trunc</li>
<li>cholesky_decompose</li>
<li>cols, dims, num_elements, rows, size</li>
<li>columns_dot_product, columns_dot_self</li>
<li>cos, cosh</li>
<li>crossprod, tcrossprod</li>
<li>diag_post_multiply, diag_pre_multiply</li>
<li>digamma</li>
<li>distance, squared_distance</li>
<li>dot_product, dot_self</li>
<li>elt_divide, operator./</li>
<li>elt_multiply, operator.*</li>
<li>erf, erfc</li>
<li>exp, exp2, expm1</li>
<li>fabs</li>
<li>hypot</li>
<li>inv, inv_cloglog, inv_logit, inv_sqrt, inv_square, inv_Phi</li>
<li>ldexp</li>
<li>lgamma</li>
<li>log, log10, log1m, log1p, log2, logit</li>
<li>log1m_exp, log1p_exp, log1m_inv_logit, log_inv_logit</li>
<li>log_diff_exp, log_inv_logit_diff</li>
<li>rows_dot_product, rows_dot_self</li>
<li>head, tail</li>
<li>mean</li>
<li>mdivide_left_tri_low, mdivide_right_tri_low</li>
<li>multiply, operator*</li>
<li>multiply_log, lmultiply</li>
<li>Phi, Phi_approx</li>
<li>pow</li>
<li>segment</li>
<li>sin, sinh</li>
<li>sqrt</li>
<li>square</li>
<li>subtract, operator-</li>
<li>sum</li>
<li>tan, tanh</li>
<li>tgamma</li>
<li>transpose</li>
</ul>
<h4><a class="anchor" id="autotoc_md133"></a>
Supported distributions</h4>
<ul>
<li>bernoulli_lpmf</li>
<li>bernoulli_logit_lpmf</li>
<li>bernoulli_logit_glm_lpmf</li>
<li>beta_lpdf</li>
<li>beta_proportion_lpdf</li>
<li>binomial_lpmf</li>
<li>categorical_logit_glm_lpmf</li>
<li>cauchy_lpdf</li>
<li>chi_square_lpdf</li>
<li>double_exponential_lpdf</li>
<li>exp_mod_normal_lpdf</li>
<li>exponential_lpdf</li>
<li>frechet_lpdf</li>
<li>gamma_lpdf</li>
<li>gumbel_lpdf</li>
<li>inv_chi_square_lpdf</li>
<li>inv_gamma_lpdf</li>
<li>logistic_lpdf</li>
<li>lognormal_lpdf</li>
<li>neg_binomial_lpmf</li>
<li>neg_binomial_2_lpmf</li>
<li>neg_binomial_2_log_lpmf</li>
<li>neg_binomial_2_log_glm_lpmf</li>
<li>normal_lpdf</li>
<li>normal_id_glm_lpdf</li>
<li>ordered_logistic_glm_lpmf</li>
<li>pareto_lpdf</li>
<li>pareto_type_2_lpdf</li>
<li>poisson_lpmf</li>
<li>poisson_log_lpmf</li>
<li>poisson_log_glm_lpmf</li>
<li>rayleigh_lpdf</li>
<li>scaled_inv_chi_square_lpdf</li>
<li>skew_normal_lpdf</li>
<li>std_normal_lpdf</li>
<li>student_t_lpdf</li>
<li>uniform_lpdf</li>
<li>weibull_lpdf</li>
</ul>
<h3><a class="anchor" id="autotoc_md134"></a>
Primitive functions</h3>
<p>OpenCL supported primitive functions can be used on <code>matrix_cl&lt;T&gt;</code> objects, where T is a primitive built-in C++ type. An example:</p>
<div class="fragment"><div class="line"><span class="keyword">using </span><a class="code hl_namespace" href="namespacestan_1_1math.html">stan::math</a>;</div>
<div class="line"> </div>
<div class="line">Eigen::Matrix&lt;double, -1, -1&gt; A = Eigen::Matrix&lt;double, -1, -1&gt;::Random(N, M);</div>
<div class="line">Eigen::Matrix&lt;double, -1, -1&gt; B = Eigen::Matrix&lt;double, -1, -1&gt;::Random(M, N);</div>
<div class="line"><a class="code hl_class" href="classstan_1_1math_1_1matrix__cl.html">matrix_cl&lt;double&gt;</a> A_cl = to_matrix_cl(A);</div>
<div class="line"><a class="code hl_class" href="classstan_1_1math_1_1matrix__cl.html">matrix_cl&lt;double&gt;</a> B_cl = to_matrix_cl(B);</div>
<div class="line"><a class="code hl_class" href="classstan_1_1math_1_1matrix__cl.html">matrix_cl&lt;double&gt;</a> C_cl = A_cl * transpose(lgamma(B_cl));</div>
<div class="line">Eigen::Matrix&lt;double, -1, -1&gt; C = from_matrix_cl(C_cl);</div>
<div class="ttc" id="aclassstan_1_1math_1_1matrix__cl_html"><div class="ttname"><a href="classstan_1_1math_1_1matrix__cl.html">stan::math::matrix_cl</a></div><div class="ttdoc">Represents an arithmetic matrix on the OpenCL device.</div><div class="ttdef"><b>Definition</b> <a href="matrix__cl_8hpp_source.html#l00047">matrix_cl.hpp:47</a></div></div>
</div><!-- fragment --><p>In addition to the functions listed in the reverse mode list, the following functions can be used with <code>matrix_cl&lt;T&gt;</code> arguments:</p>
<ul>
<li>append_col, append_row</li>
<li>gp_exp_quad_cov</li>
<li>trace</li>
<li>trigamma </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->

<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">
    <div class="contents" style="font-size:100%;">
      <span style="float:left; margin=0 1em 0 1em;">
      &nbsp;&nbsp;&nbsp;&nbsp;
      [ <a href="http://mc-stan.org/">Stan Home Page</a> ]
      </span>
      <span style="float:right; margin=0 1em 0 1em;">
      <i>&copy; 2011&ndash;2019,
      Stan Development Team.
      &nbsp;&nbsp;&nbsp;&nbsp;
      </i>
      </span>
    </div> </li>
  </ul>
</div>
</body>
</html>
