<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.7"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Stan Math Library: TBB Threading</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js", "TeX/AMSmath.js", "TeX/AMSsymbols.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="standoxy.css" rel="stylesheet" type="text/css">
<!--  -->
<script type="text/javascript" src="eigen_navtree_hacks.js"></script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="stanlogo-main.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname"><a href="https://mc-stan.org/math">Stan Math Library</a>
   &#160;<span id="projectnumber">5.0.0</span>
   </div>
   <div id="projectbrief">Automatic Differentiation</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.7 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_doxygen_2parallelism__support_2threading__tbb.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">TBB Threading</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>By default the <code>stan-math</code> library is not thread safe which is due to the requirement that the autodiff stack uses a global autodiff tape which records all operations of functions being evaluated. Starting with version 2.18 of <code>stan-math</code> threading support can be switched on using the compile-time switch <code>STAN_THREADS</code>. Defining this variable at compile time can be achieved by adding to <code>make/local</code> </p><div class="fragment"><div class="line">CXXFLAGS += -DSTAN_THREADS</div>
</div><!-- fragment --><p> Once this is set <code>stan-math</code> will use the C++11 <code>thread_local</code> facility such that the autodiff stack is maintained per thread and not anymore globally. This allows the use of autodiff in a threaded application as this enables the calculation of the derivatives of a function inside a thread (the function itself may not use threads). Only if the function to be evaluated is composed of independent tasks it maybe possible to evaluate derivatives of a function in a threaded approach. An example of a threaded gradient evaluation is the <code>map_rect</code> function in <code>stan-math</code>.</p>
<p>In addition to making <code>stan-math</code> thread safe this also turns on parallel execution support of the <code>map_rect</code> function. Currently, the maximal number of threads being used by the function is controlled by the environment variable <code>STAN_NUM_THREADS</code> at runtime. Setting this variable to a positive integer number defines the maximal number of threads being used. In case the variable is set to the special value of <code>-1</code> this requests that as many threads as physical cores are being used. If the variable is not set a single thread is used. Any illegal value (not an integer, zero, other negative) will cause an exception to be thrown.</p>
<h1><a class="anchor" id="autotoc_md135"></a>
Intel Threading Building Blocks</h1>
<p>The Intel TBB library is used in stan-math since version 2.21.0. The Intel TBB library uses a threadpool internally and distributes work through a task-based approach. The tasks are dispatched to the threadpool via a the Intel TBB work-stealing scheduler. For example, whenever threading is enabled via <code>STAN_THREADS</code> the <code>map_rect</code> function in stan-math will use the <code>tbb::parallel_for</code> of the TBB. This will execute the work chunks given to <code>map_rect</code> with scheduling and thus load-balance CPU core utilization.</p>
<p>By default stan-math builds only the main <code>tbb</code> library by defining the <code>makefile</code> variable</p>
<div class="fragment"><div class="line">TBB_LIBRARIES=tbb</div>
</div><!-- fragment --><p>The Intel TBB provides in addition to the main library memory allocators which are specifically designed to speedup threaded programs. These speedups have so far only been observed on MacOS systems for Stan programs such that on MacOS the default is set to</p>
<div class="fragment"><div class="line">TBB_LIBRARIES=tbb tbbmalloc tbbmalloc_proxy</div>
</div><!-- fragment --><p>Users may override the default choices by defining <code>TBB_LIBRARIES</code> in the <code>make/local</code> file manually. Please refer to the <a href="https://github.com/stan-dev/math/pull/1376">pull request</a> which merged the Intel TBB for further details on the performance evaluations.</p>
<h1><a class="anchor" id="autotoc_md136"></a>
Requirements</h1>
<p>Threading support requires a fully C++11 compliant compiler which has a working <code>thread_local</code> implementation. Below you find for each operating system what is known to work. Known to work configurations refers to run successfully by developers.</p>
<p>The compiler support for the C++11 <code>thread_local</code> keyword for the major open-source compilers is available since these versions:</p>
<ul>
<li>GNU g++ 4.8.1, <a href="https://gcc.gnu.org/projects/cxx-status.html">see here</a>; please also add <code>-pthread</code> to the <code>CXXFLAGS</code> variable</li>
<li>clang++ 3.3, <a href="https://clang.llvm.org/cxx_status.html">see here</a> Note: clang + linux long had issues with <code>thread_local</code> which should be fixed with clang &gt;=4.0</li>
</ul>
<h2><a class="anchor" id="autotoc_md137"></a>
Mac OS X</h2>
<p>Known to work:</p><ul>
<li>macOS R toolchain, clang 4, <a href="https://github.com/coatless/r-macos-rtools">see here</a></li>
<li>Apple's clang 9.1.0 (Xcode 9.1) on macOS High Sierra</li>
<li>Apple's clang 11.0.0 (Xcode 9.1) on macOS Mojave</li>
<li>g++ 6.4.0 from macports</li>
</ul>
<p>Should work:</p><ul>
<li>Apple's clang compilers support the <code>thread_local</code> keyword since Mac OS Sierra (Xcode 8.0)</li>
</ul>
<h2><a class="anchor" id="autotoc_md138"></a>
Linux</h2>
<p>Known to work:</p><ul>
<li>GNU g++ 4.9 - this configuration is also tested</li>
</ul>
<p>With <code>clang</code> on linux there are issues during the linking step of programs which happens on old distributions like ubuntu trusty 14.04 (the 16.04 LTS is fine). A solution can be <a href="https://stackoverflow.com/questions/29322666/undefined-reference-to-cxa-thread-atexitcxxabi-when-compiling-with-libc#30437761">found here.</a> It is likely that clang 4.0 <em>if used with libc++ 4.0</em> will work just fine, but developers have not yet confirmed this.</p>
<h2><a class="anchor" id="autotoc_md139"></a>
Windows</h2>
<p>Known to work:</p><ul>
<li>RTools 3.5 for Windows which uses mingw g++ 4.9.1 (since stan-math 2.20.0)</li>
<li>RTools 4.0 for Windows with a port of GNU g++ 8.2, that compiler can also be used with CmdStan </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->

<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">
    <div class="contents" style="font-size:100%;">
      <span style="float:left; margin=0 1em 0 1em;">
      &nbsp;&nbsp;&nbsp;&nbsp;
      [ <a href="http://mc-stan.org/">Stan Home Page</a> ]
      </span>
      <span style="float:right; margin=0 1em 0 1em;">
      <i>&copy; 2011&ndash;2019,
      Stan Development Team.
      &nbsp;&nbsp;&nbsp;&nbsp;
      </i>
      </span>
    </div> </li>
  </ul>
</div>
</body>
</html>
