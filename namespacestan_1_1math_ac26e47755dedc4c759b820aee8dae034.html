<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.7"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Stan Math Library: stan::math::map_rect</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js", "TeX/AMSmath.js", "TeX/AMSsymbols.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="standoxy.css" rel="stylesheet" type="text/css">
<!--  -->
<script type="text/javascript" src="eigen_navtree_hacks.js"></script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="stanlogo-main.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname"><a href="https://mc-stan.org/math">Stan Math Library</a>
   &#160;<span id="projectnumber">5.0.0</span>
   </div>
   <div id="projectbrief">Automatic Differentiation</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.7 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('namespacestan_1_1math_ac26e47755dedc4c759b820aee8dae034.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="contents">
<a id="ac26e47755dedc4c759b820aee8dae034" name="ac26e47755dedc4c759b820aee8dae034"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ac26e47755dedc4c759b820aee8dae034">&#9670;&#160;</a></span>map_rect()</h2>

<div class="memitem">
<div class="memproto">
<div class="memtemplate">
template&lt;int call_id, typename F , typename T_shared_param , typename T_job_param , <a class="el" href="group__eigen__col__vector__types_ga2d884dd17cfd961ad12df40a9ba3aaa2.html#ga2d884dd17cfd961ad12df40a9ba3aaa2">require_eigen_col_vector_t</a>&lt; T_shared_param &gt; *  = nullptr&gt; </div>
      <table class="memname">
        <tr>
          <td class="memname">Eigen::Matrix&lt; <a class="el" href="group__type__trait_gacbaff683cd2683209e6855e2c7aaeffe.html#gacbaff683cd2683209e6855e2c7aaeffe">return_type_t</a>&lt; T_shared_param, T_job_param &gt;, Eigen::Dynamic, 1 &gt; stan::math::map_rect </td>
          <td>(</td>
          <td class="paramtype">const T_shared_param &amp;&#160;</td>
          <td class="paramname"><em>shared_params</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const std::vector&lt; Eigen::Matrix&lt; T_job_param, Eigen::Dynamic, 1 &gt; &gt; &amp;&#160;</td>
          <td class="paramname"><em>job_params</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const std::vector&lt; std::vector&lt; double &gt; &gt; &amp;&#160;</td>
          <td class="paramname"><em>x_r</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const std::vector&lt; std::vector&lt; int &gt; &gt; &amp;&#160;</td>
          <td class="paramname"><em>x_i</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::ostream *&#160;</td>
          <td class="paramname"><em>msgs</em> = <code>nullptr</code>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Map N function evaluations to parameters and data which are in rectangular format. </p>
<p>Each function evaluation may return a column vector of different sizes and the output is the concatenated vector from all evaluations.</p>
<p>In addition to job specific parameters, real and int data, a shared parameter vector is repeated in all evaluations. All input parameters are stored as vectors whereas data is stored as arrays.</p>
<p>For N jobs the output of this function is</p>
<p>[ f(shared_params, job_params[1], x_r[1], x_i[1]), f(shared_params, job_params[2], x_r[2], x_i[2]), ... ]'.</p>
<p>The function is implemented with serial execution and with parallelism using threading or MPI (TODO). The threading version is used if the compiler flag STAN_THREADS is set during compilation while the MPI version is only available if STAN_MPI is defined. The MPI parallelism takes precedence over serial or threading execution of the function.</p>
<p>For the threaded parallelism the N jobs are chunked into T blocks which are executed asynchronously using the async C++11 facility. This ensure that at most T threads are used, but the actual number of threads is controlled by the implementation of async provided by the compiler. Note that nested calls of map_rect will lead to a multiplicative increase in the number of job chunks generated. The number of threads T is controlled at runtime via the STAN_NUM_threads environment variable, see the get_num_threads function for details.</p>
<p>For the MPI version to work this function has these special non-standard conventions:</p>
<ul>
<li>The call_id template parameter is considered as a label for the functor F and data combination. Since MPI communication is expensive, the real and int data is transmitted only a single time per functor F / call_id combination to the workers.</li>
<li>The MPI implementation requires that the functor type fully specifies the functor and hence requires a default constructible function object. This choice reduces the need for communication across MPI as the type is sufficient and the state of the functor is not necessary to transmit. Thus, the functor is specified as template argument only.</li>
<li>The size of the returned vector of each job must stay consistent when performing repeated calls to map_rect (which usually vary the values of the parameters).</li>
<li>To achieve the exact same results between the serial and the MPI evaluation scheme both variants work in exactly the same way which is to use nested AD calls and pre-computing all gradients when the function gets called. The usual evaluation scheme would build an AD graph instead of doing on-the-spot gradient evaluation. For large problems this results in speedups for the serial version even on a single core due to smaller AD graph sizes.</li>
<li>In MPI operation mode, no outputs from the workers are streamed back to the root.</li>
<li>Finally, each map_rect call must be registered with the STAN_REGISTER_MAP_RECT macro. This is required to enable communication between processes for the MPI case. The macro definition is empty if MPI is not enabled.</li>
</ul>
<p>The functor F is expected to have the usual operator() function with signature</p>
<p>template &lt;typename T1, typename T2&gt; Eigen::Matrix&lt;return_type_t&lt;T1, T2&gt;, Eigen::Dynamic, 1&gt; operator()(const Eigen::Matrix&lt;T1, Eigen::Dynamic, 1&gt;&amp; eta, const Eigen::Matrix&lt;T2, Eigen::Dynamic, 1&gt;&amp; theta, const std::vector&lt;double&gt;&amp; x_r, const std::vector&lt;int&gt;&amp; x_i, std::ostream* msgs = 0) const { ... }</p>
<p>If an expression is passed as <code>shared_params</code>, the functor needs to accept expression.</p>
<p>WARNING: For the MPI case, the data arguments are NOT checked if they are unchanged between repeated evaluations for a given call_id/functor F pair. This is silently assumed to be immutable between evaluations.</p>
<dl class="tparams"><dt>Template Parameters</dt><dd>
  <table class="tparams">
    <tr><td class="paramname">T_shared_param</td><td>Type of shared parameters. </td></tr>
    <tr><td class="paramname">T_job_param</td><td>Type of job specific parameters. </td></tr>
  </table>
  </dd>
</dl>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">shared_params</td><td>shared parameter vector passed as first argument to functor for all jobs </td></tr>
    <tr><td class="paramname">job_params</td><td>Array of job specific parameter vectors. All job specific parameters must have matching sizes. </td></tr>
    <tr><td class="paramname">x_r</td><td>Array of real arrays for each job. The first dimension must match the number of jobs (which is determined by the first dimension of job_params) and each entry must have the same size. </td></tr>
    <tr><td class="paramname">x_i</td><td>Array of int data with the same conventions as x_r. </td></tr>
    <tr><td class="paramname">msgs</td><td>Output stream for messages. </td></tr>
  </table>
  </dd>
</dl>
<dl class="tparams"><dt>Template Parameters</dt><dd>
  <table class="tparams">
    <tr><td class="paramname">call_id</td><td>Label for functor/data combination. See above for details. </td></tr>
    <tr><td class="paramname">F</td><td>Functor which is applied to all job specific parameters with conventions described. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>concatenated results from all jobs </dd></dl>

<p class="definition">Definition at line <a class="el" href="map__rect_8hpp_source.html#l00127">127</a> of file <a class="el" href="map__rect_8hpp_source.html">map_rect.hpp</a>.</p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->

<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="namespacestan.html">stan</a></li><li class="navelem"><a class="el" href="namespacestan_1_1math.html">math</a></li>
    <li class="footer">
    <div class="contents" style="font-size:100%;">
      <span style="float:left; margin=0 1em 0 1em;">
      &nbsp;&nbsp;&nbsp;&nbsp;
      [ <a href="http://mc-stan.org/">Stan Home Page</a> ]
      </span>
      <span style="float:right; margin=0 1em 0 1em;">
      <i>&copy; 2011&ndash;2019,
      Stan Development Team.
      &nbsp;&nbsp;&nbsp;&nbsp;
      </i>
      </span>
    </div> </li>
  </ul>
</div>
</body>
</html>
